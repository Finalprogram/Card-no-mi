<header class="navbar-wrapper">

  <div class="container">

    <nav class="navbar">
  <a href="/" class="navbar-logo-link">
    <img src="/images/Horizontal.png" alt="Logo Car'D No Mi" class="navbar-logo-img">
  </a>

      <ul class="navbar-menu">
    <li class="navbar-dropdown">
      <a href="#" class="dropdown-toggle-navbar">
        Explorar Cartas
        <span class="dropdown-arrow">‚ñº</span>
      </a>
      <div class="dropdown-menu-navbar">
        <a href="/cards" class="dropdown-item-navbar">Cartas √† Venda</a>
        <a href="/encyclopedia" class="dropdown-item-navbar">Enciclop√©dia</a>
      </div>
    </li>
    <li><a href="/decks/community">Deck Builder</a></li>
    <li class="navbar-dropdown">
      <a href="#" class="dropdown-toggle-navbar">
        Comunidade
        <span class="dropdown-arrow">‚ñº</span>
      </a>
      <div class="dropdown-menu-navbar">
        <a href="/comunidade" class="dropdown-item-navbar">P√°gina da Comunidade</a>
        <a href="/forum" class="dropdown-item-navbar">F√≥rum</a>
        <% if (user) { %>
        <a href="/forum/achievements" class="dropdown-item-navbar">üèÜ Conquistas</a>
        <a href="/forum/missions" class="dropdown-item-navbar">‚öîÔ∏è Miss√µes Di√°rias</a>
        <% } %>
      </div>
    </li>
    <li><a href="/about">Sobre</a></li>
    <% if (user && (user.role === 'moderator' || user.role === 'admin')) { %>
    <li>
      <a href="/forum/moderation" class="moderation-link">
        üõ°Ô∏è Modera√ß√£o
        <% if (user.pendingReportsCount && user.pendingReportsCount > 0) { %>
          <span class="report-badge"><%= user.pendingReportsCount %></span>
        <% } %>
      </a>
    </li>
    <% } %>
</ul>

      <div class="navbar-actions">
          <% if (user) { %>
              <!-- Notifica√ß√µes com Dropdown -->
              <div class="notification-dropdown-container">
                  <button class="notification-bell" id="notificationBellBtn">
                      <i class="fas fa-bell"></i>
                      <span class="notification-badge" style="display: none;">0</span>
                  </button>
                  
                  <div class="notification-dropdown" id="notificationDropdown" style="display: none;">
                      <div class="notification-dropdown-header">
                          <h3>Notifica√ß√µes</h3>
                          <button class="mark-all-read-btn" id="markAllReadBtn" title="Marcar todas como lidas">
                              <i class="fas fa-check-double"></i>
                          </button>
                      </div>
                      <div class="notification-dropdown-body" id="notificationList">
                          <div class="notification-loading">
                              <i class="fas fa-spinner fa-spin"></i>
                              <p>Carregando...</p>
                          </div>
                      </div>
                      <div class="notification-dropdown-footer">
                          <a href="/forum/notifications">Ver todas as notifica√ß√µes</a>
                      </div>
                  </div>
              </div>
              
              <a href="/vender" class="btn-primary btn-sell-now-navbar">Vender Agora</a>
              <div class="user-dropdown">
                  <div class="dropdown-toggle">
                      <img src="<%= user.avatar || '/images/default-avatar.png' %>" alt="Avatar do usu√°rio" class="avatar">
                      <span class="navbar-user-greeting"><%= user.username %></span>
                      <span class="dropdown-arrow">‚ñº</span>
                  </div>
                  <div class="dropdown-menu">
                      <a href="/forum/user/<%= user.username %>" class="dropdown-item">
                          <i class="fas fa-user"></i> Perfil do F√≥rum
                      </a>
                      <a href="/forum/notifications" class="dropdown-item">
                          <i class="fas fa-bell"></i> Notifica√ß√µes
                      </a>
                      <div class="dropdown-divider"></div>
                      <a href="/perfil/<%= user.id %>" class="dropdown-item">Meu Perfil</a>
                      <a href="/meus-anuncios" class="dropdown-item">Meus An√∫ncios</a>
                      <a href="/meus-pedidos" class="dropdown-item">Minhas Compras</a>
                      <a href="/meus-pedidos-vendidos" class="dropdown-item">Minhas Vendas</a>
                      <a href="/dashboard-vendedor" class="dropdown-item">Dashboard</a>
                      <div class="dropdown-divider"></div>
                      <a href="/auth/logout" class="dropdown-item logout-btn">Sair</a>
                  </div>
              </div>
              
              <!-- Script para sistema de notifica√ß√µes com dropdown -->
              <script>
                // Estado do dropdown
                let notificationsLoaded = false;
                
                // Elementos
                const notificationBell = document.getElementById('notificationBellBtn');
                const notificationDropdown = document.getElementById('notificationDropdown');
                const notificationList = document.getElementById('notificationList');
                const markAllReadBtn = document.getElementById('markAllReadBtn');
                
                // Fun√ß√£o para atualizar o contador de notifica√ß√µes
                async function updateNotificationCount() {
                  try {
                    const response = await fetch('/forum/api/notifications/unread-count');
                    const data = await response.json();
                    const badge = document.querySelector('.notification-badge');
                    if (badge && data.count !== undefined) {
                      if (data.count > 0) {
                        badge.textContent = data.count > 99 ? '99+' : data.count;
                        badge.style.display = 'block';
                      } else {
                        badge.style.display = 'none';
                      }
                    }
                  } catch (error) {
                    console.error('Erro ao buscar notifica√ß√µes:', error);
                  }
                }
                
                // Fun√ß√£o para carregar notifica√ß√µes recentes
                async function loadRecentNotifications() {
                  try {
                    const response = await fetch('/forum/api/notifications/recent');
                    const data = await response.json();
                    
                    if (data.notifications && data.notifications.length > 0) {
                      notificationList.innerHTML = data.notifications.map(notif => {
                        const timeAgo = getTimeAgo(new Date(notif.createdAt));
                        const unreadClass = notif.isRead ? '' : 'unread';
                        
                        return `
                          <div class="notification-item ${unreadClass}" data-id="${notif._id}">
                            <div class="notification-icon">
                              ${getNotificationIcon(notif.type)}
                            </div>
                            <div class="notification-content">
                              <p class="notification-message">${notif.message}</p>
                              <span class="notification-time">${timeAgo}</span>
                            </div>
                            ${notif.link ? `<a href="${notif.link}" class="notification-link-overlay"></a>` : ''}
                          </div>
                        `;
                      }).join('');
                    } else {
                      notificationList.innerHTML = `
                        <div class="notification-empty">
                          <i class="fas fa-bell-slash"></i>
                          <p>Nenhuma notifica√ß√£o</p>
                        </div>
                      `;
                    }
                    
                    notificationsLoaded = true;
                  } catch (error) {
                    console.error('Erro ao carregar notifica√ß√µes:', error);
                    notificationList.innerHTML = `
                      <div class="notification-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Erro ao carregar notifica√ß√µes</p>
                      </div>
                    `;
                  }
                }
                
                // Fun√ß√£o para obter √≠cone baseado no tipo de notifica√ß√£o
                function getNotificationIcon(type) {
                  const icons = {
                    'thread_reply': '<i class="fas fa-reply"></i>',
                    'post_reply': '<i class="fas fa-comment"></i>',
                    'reply': '<i class="fas fa-comment"></i>',
                    'mention': '<i class="fas fa-at"></i>',
                    'quote': '<i class="fas fa-quote-left"></i>',
                    'upvote': '<i class="fas fa-arrow-up"></i>',
                    'thread_pinned': '<i class="fas fa-thumbtack"></i>',
                    'thread_moved': '<i class="fas fa-exchange-alt"></i>',
                    'thread_locked': '<i class="fas fa-lock"></i>',
                    'rank_up': '<i class="fas fa-level-up-alt"></i>',
                    'reputation': '<i class="fas fa-star"></i>',
                    'sale': '<i class="fas fa-shopping-cart"></i>',
                    'order_status': '<i class="fas fa-box"></i>',
                    'system': '<i class="fas fa-info-circle"></i>'
                  };
                  return icons[type] || '<i class="fas fa-bell"></i>';
                }
                
                // Fun√ß√£o para calcular tempo relativo
                function getTimeAgo(date) {
                  const seconds = Math.floor((new Date() - date) / 1000);
                  
                  if (seconds < 60) return 'Agora';
                  if (seconds < 3600) return `${Math.floor(seconds / 60)}min`;
                  if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
                  if (seconds < 604800) return `${Math.floor(seconds / 86400)}d`;
                  return date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                }
                
                // Toggle dropdown
                notificationBell.addEventListener('click', (e) => {
                  e.stopPropagation();
                  const isVisible = notificationDropdown.style.display === 'block';
                  
                  if (!isVisible) {
                    notificationDropdown.style.display = 'block';
                    if (!notificationsLoaded) {
                      loadRecentNotifications();
                    }
                  } else {
                    notificationDropdown.style.display = 'none';
                  }
                });
                
                // Fechar dropdown ao clicar fora
                document.addEventListener('click', (e) => {
                  if (!notificationDropdown.contains(e.target) && e.target !== notificationBell) {
                    notificationDropdown.style.display = 'none';
                  }
                });
                
                // Marcar todas como lidas
                markAllReadBtn.addEventListener('click', async () => {
                  try {
                    const response = await fetch('/forum/api/notifications/read-all', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                      updateNotificationCount();
                      loadRecentNotifications();
                    }
                  } catch (error) {
                    console.error('Erro ao marcar notifica√ß√µes como lidas:', error);
                  }
                });
                
                // Marcar notifica√ß√£o como lida ao clicar
                notificationList.addEventListener('click', async (e) => {
                  const notifItem = e.target.closest('.notification-item');
                  if (notifItem && notifItem.classList.contains('unread')) {
                    const notifId = notifItem.dataset.id;
                    try {
                      await fetch(`/forum/api/notifications/${notifId}/read`, {
                        method: 'POST'
                      });
                      notifItem.classList.remove('unread');
                      updateNotificationCount();
                    } catch (error) {
                      console.error('Erro ao marcar notifica√ß√£o como lida:', error);
                    }
                  }
                });
                
                // Atualizar ao carregar a p√°gina
                updateNotificationCount();
                
                // Atualizar a cada 30 segundos
                setInterval(updateNotificationCount, 30000);
              </script>
          <% } else { %>
              <a href="/auth/login" class="btn-secondary">Entrar</a>
              <a href="/auth/register" class="btn-primary">Cadastrar</a>
          <% } %>
      </div>
    </nav>
    
  </div>
</header>