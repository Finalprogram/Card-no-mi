<%- include('../partials/header') %>
<style>
  .ability-badge {
    position: absolute;
    top: 5px;
    left: 5px;
    background-color: #ff0000;
    color: #fff;
    padding: 2px 5px; /* Adjusted for smaller items */
    border-radius: 6px;
    font-size: 0.65rem; /* Adjusted for smaller items */
    font-weight: 600;
    white-space: nowrap;
    line-height: 1;
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
  }
  .card-image-container {
    position: relative;
    width: 48px; /* Match the .ck-thumb width */
    height: 68px; /* Match the .ck-thumb height */
  }
  .ck-thumb {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 6px;
  }
</style>

<body class="public-site">

<div class="container">
  <%- include('../partials/navbar') %>

  <main>
    <h1 style="margin: 24px 0 16px;">Checkout</h1>

  <% if (typeof message !== 'undefined' && message) { %>
    <div class="alert alert-<%= message.type %>" role="alert">
      <%= message.text %>
    </div>
  <% } %>

  <form action="/checkout/confirm" method="post" id="checkout-form" class="panel" style="background:var(--bg-surface); padding:20px; border-radius:12px; border:1px solid var(--border)">

    <div class="shipping-quote-section">
      <h3 style="margin: 10px 0 6px;">Calcular Frete</h3>
      <div class="form-group">
        <label for="zip-input">CEP de Entrega</label>
        <input class="form-control" id="zip-input" name="zip" placeholder="Digite seu CEP" value="<%= user.address.cep %>">
      </div>
      <button type="button" id="calculate-shipping-btn" class="btn btn-secondary">Calcular</button>
      <div id="shipping-options-container" style="margin-top: 1rem;"></div>
    </div>

    <div class="coupon-section panel" style="background:var(--bg-surface); padding:20px; border-radius:12px; border:1px solid var(--border); margin-bottom: 20px;">
      <h3 style="margin: 10px 0 6px;">Cupom de Desconto</h3>
      <div class="form-group" style="display:flex; gap:10px;">
        <input type="text" class="form-control" id="coupon-code-input" placeholder="Insira seu cupom" style="flex-grow:1;">
        <button type="button" id="apply-coupon-btn" class="btn btn-secondary">Aplicar</button>
      </div>
      <div id="coupon-message" style="margin-top: 10px;"></div>
    </div>

    <hr style="border-color: var(--border); margin: 16px 0; opacity:.4">

    <h3 style="margin: 10px 0 6px;">Resumo do Pedido</h3>

    <!-- listagem de pacotes + itens (server-render) -->
    <div id="packages">
      <% if ((groups || []).length === 0) { %>
        <div class="empty">Seu carrinho está vazio.</div>
      <% } %>

      <% (groups || []).forEach(function(g){ %>
        <div class="ship-package panel" data-seller="<%= g.sellerId %>" style="border:1px solid var(--border); border-radius:10px; padding:12px; margin:10px 0; background:var(--bg-surface)">
          <h4 style="margin:6px 0 10px;">Vendedor: <%= g.sellerName %></h4>

          <ul class="ck-items" style="list-style:none; margin:0 0 10px; padding:0; display:flex; flex-direction:column; gap:8px;">
            <% g.items.forEach(function(it){ %>
              <li class="ck-item" style="display:flex; align-items:center; gap:10px; border:1px solid var(--border); border-radius:8px; padding:8px;">
                <% if (it.imageUrl) { %>
                  <div class="card-image-container">
                    <img src="<%= it.imageUrl %>" alt="" class="ck-thumb">
                    <% if (it.is_foil) { %>
                        <div class="ability-badge">Foil</div>
                    <% } %>
                  </div>
                <% } %>
                <div class="ck-info" style="flex:1;">
                  <div class="ck-title" style="font-weight:600;"><%= it.name %> <span style="opacity:.7"><%= it.condition %></span></div>
                  <div class="ck-meta" style="opacity:.8; font-size:.92rem;">Qtd: <%= it.qty %> — Unit: <%= formatPrice(it.unit) %></div>
                </div>
                <div class="ck-line" style="min-width:110px; text-align:right; font-weight:700;"><%= formatPrice(it.line) %></div>
              </li>
            <% }) %>
          </ul>
        </div>
      <% }) %>
    </div>

    <!-- selections (JSON) enviados no POST -->
    <input type="hidden" name="shippingSelections" id="shippingSelections" value="[]">

    <div class="totals" style="margin-top:14px; border-top:1px solid var(--border); padding-top:12px;">
      <div style="display:flex; justify-content:space-between; margin:6px 0;">
        <span>Subtotal</span><strong id="ck-subtotal"><%= formatPrice(totals.subtotal) %></strong>
      </div>
      <div style="display:flex; justify-content:space-between; margin:6px 0;">
        <span>Frete</span><strong id="ck-shipping"><%= formatPrice(totals.shipping) %></strong>
      </div>
      <div id="coupon-discount-row" style="display:<%= (totals.couponDiscount && totals.couponDiscount > 0) ? 'flex' : 'none'%>; justify-content:space-between; margin:6px 0; color: var(--accent-primary);">
        <span>Desconto do Cupom</span><strong id="ck-coupon-discount">-<%= formatPrice(totals.couponDiscount) %></strong>
        <button type="button" id="remove-coupon-btn" class="btn btn-sm btn-secondary" style="margin-left: 10px;">Remover</button>
      </div>

      <div class="grand" style="display:flex; justify-content:space-between; margin:10px 0; font-size:1.1rem;">
        <span>Total</span><strong id="ck-grand" style="color:var(--accent-primary);"><%= formatPrice(totals.grand) %></strong>
      </div>
    </div>

    <button class="btn btn-primary btn-submit-full" type="submit">Ir para Pagamento</button>
  </form>
  </main>
</div>

<%- include('../partials/footer') %>
</body>
</html>

<script src="/js/checkout.js"></script>

