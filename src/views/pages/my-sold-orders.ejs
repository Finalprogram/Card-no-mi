<%- include('../partials/header') %>
<style>
  .order-list-item {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
  }
  .order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
  }
  .order-info {
    display: flex;
    gap: 2rem;
    align-items: center;
  }
  .order-id,
  .order-date,
  .order-buyer,
  .order-status {
    display: flex;
    flex-direction: column;
  }
  .order-info .label {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 2px;
  }
  .order-info .value {
    font-weight: 600;
  }
  .badge {
    display: inline-block;
    padding: 0.3em 0.6em;
    border-radius: 10px; /* Rounded corners for the badge */
    font-size: 0.75em;
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    color: #fff; /* Default text color for badges */
  }
  .badge-PendingPayment {
    background-color: #e0c547; /* Cooler Yellow for pending */
    color: #fff;
  }
  .badge-Paid {
    background-color: #198754; /* Cooler Green for paid */
  }
  .badge-Shipped {
    background-color: #007bff; /* Blue for shipped */
  }
  .badge-Delivered {
    background-color: #6610f2; /* Indigo for delivered */
  }
  .badge-Cancelled {
    background-color: #dc3545; /* Red for cancelled */
  }
  .badge-Processing {
    background-color: #6c757d; /* Gray for processing */
  }
  .order-items {
    margin-top: 1rem;
  }
  .item-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border-muted);
  }
  .item-row:last-child {
    border-bottom: none;
  }
  .item-prices {
    text-align: right;
  }
  .item-price-gross {
    font-size: 0.8em; /* Smaller font size */
    color: var(--text-muted);
  }
  .item-price-net {
    font-size: 0.9em; /* Slightly larger than gross, but still smaller than default */
  }
  /* Modal Styles */
  .modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1; /* Sit on top */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
  }
  .modal-content {
    background-color: var(--bg-surface);
    margin: 15% auto; /* 15% from the top and centered */
    padding: 20px;
    border: 1px solid var(--border);
    width: 80%; /* Could be more or less, depending on screen size */
    border-radius: 8px;
    position: relative;
  }
  .generate-label-btn:hover {
    background-color: var(--accent-primary) !important; /* Use !important to override btn-success */
    border-color: var(--accent-primary) !important;
    color: var(--bg-primary) !important;
  }
  .btn-info:hover {
    background-color: var(--accent-primary) !important;
    border-color: var(--accent-primary) !important;
    color: var(--bg-primary) !important;
  }
  .close-btn {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
  }
  .close-btn:hover,
  .close-btn:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }
  .primary-link {
    color: var(--accent-primary);
    text-decoration: none;
  }
  .primary-link:hover {
    text-decoration: underline;
    background-color: rgba(var(--accent-primary-rgb), 0.1); /* Light background on hover */
    border-radius: 4px;
  }
  .primary-link:hover {
    text-decoration: underline;
  }

  .timeline-container {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
  }

  .timeline {
    display: flex;
    justify-content: space-between;
    list-style: none;
    padding: 0;
    margin: 0;
    position: relative;
  }

  .timeline::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 2px;
    background-color: var(--border);
    transform: translateY(-50%);
    z-index: -1;
  }

  .timeline-step {
    text-align: center;
    position: relative;
    width: 100%;
  }

  .timeline-step-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .timeline-step-marker {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background-color: var(--border);
    border: 3px solid var(--bg-surface);
    z-index: 1;
  }

  .timeline-step-label {
    margin-top: 0.5rem;
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  /* Completed state */
  .timeline-step.completed .timeline-step-marker {
    background-color: var(--accent-primary);
  }

  .timeline-step.completed .timeline-step-label {
    color: var(--text-primary);
    font-weight: 600;
  }

  /* Current state */
  .timeline-step.current .timeline-step-marker {
    background-color: var(--accent-primary);
    transform: scale(1.2);
    box-shadow: 0 0 0 4px rgba(var(--accent-primary-rgb), 0.2);
  }

  .timeline-step.current .timeline-step-label {
    color: var(--accent-primary);
    font-weight: 700;
  }

  /* Cancelled state */
  .timeline-step.cancelled .timeline-step-marker {
    background-color: #dc3545; /* Red for cancelled */
  }

  .timeline-step.cancelled .timeline-step-label {
    color: #dc3545;
    font-weight: 600;
  }
</style>

<main class="container" style="max-width: 880px; margin-top: 24px;">
  <%- include('../partials/navbar') %>

  <h1 style="margin: 24px 0 16px;">Minhas Vendas</h1>

  <div class="orders-container">
    <% if (orders && orders.length > 0) { %>
      <% orders.forEach(order => { %>
        <% 
          const statusTranslations = {
            'PendingPayment': 'Pagamento Pendente',
            'Paid': 'Pago',
            'Processing': 'Processando',
            'Shipped': 'Enviado',
            'Delivered': 'Entregue',
            'Cancelled': 'Cancelado',
          };
        %>
        <div class="order-list-item">
          <div class="order-header">
            <div class="order-info">
              <div class="order-id">
                <span class="label">Pedido</span>
                <span class="value">#<%= order._id.toString().slice(-6) %></span>
              </div>
              <div class="order-date">
                <span class="label">Data</span>
                <span class="value"><%= new Date(order.createdAt).toLocaleDateString('pt-BR') %></span>
              </div>
              <div class="order-buyer">
                <span class="label">Comprador</span>
                <span class="value"><%= order.user.username %></span>
              </div>
              <div class="order-status">
                <% 
                  const translatedStatus = statusTranslations[order.status] || order.status;
                %>
                <span class="value badge badge-<%= order.status %>"><%= translatedStatus %></span>
                <% if (order.status === 'Paid') { %>
                  <%# Show "Generate Label" button ONLY if a label doesn't exist yet %>
                  <% if (!order.melhorEnvioLabelUrl) { %>
                    <button class="btn btn-sm btn-success generate-label-btn" data-order-id="<%= order._id %>">Gerar Etiqueta ME</button>
                  <% } %>
                  <%# Show "Mark as Shipped" button ALWAYS if the order is Paid %>
                  <button class="btn btn-sm btn-primary mark-as-shipped-btn" data-order-id="<%= order._id %>" style="margin-left: 5px;">Marcar como Enviado</button>
                <% } else if (order.status === 'Shipped' && order.melhorEnvioLabelUrl) { %>
                  <a href="<%= order.melhorEnvioLabelUrl %>" target="_blank" class="btn btn-sm btn-info" style="margin-left: 10px;">Ver Etiqueta</a>
                <% } %>
              </div>
            </div>
          </div>
          <div class="order-items">
            <h4 style="margin-bottom: 0.5rem;">Itens Vendidos</h4>
            <% order.items.forEach(item => { %>
              <div class="item-row">
                <span><%= item.cardName %> (Qtd: <%= item.quantity %>)</span>
                <div class="item-prices">
                  <div class="item-price-gross">Preço Bruto: <%= formatPrice(item.price * item.quantity) %></div>
                  <div class="item-price-net">Líquido Vendedor: <strong><%= formatPrice(item.sellerNet) %></strong></div>
                </div>
              </div>
            <% }) %>
          </div>

          <div class="timeline-container">
            <ul class="timeline">
              <% const statuses = ['PendingPayment', 'Processing', 'Paid', 'Shipped', 'Delivered']; %>
              <% const currentStatusIndex = statuses.indexOf(order.status); %>
              <% statuses.forEach((status, index) => { %>
                <% 
                  let statusClass = '';
                  if (index < currentStatusIndex) {
                    statusClass = 'completed';
                  } else if (index === currentStatusIndex) {
                    statusClass = 'current';
                  }

                  // Handle 'Cancelled' status separately
                  if (order.status === 'Cancelled') {
                    if (status === 'PendingPayment') { // Or wherever you want to show the cancelled state
                      statusClass = 'cancelled';
                    }
                  }
                %>
                <li class="timeline-step <%= statusClass %>">
                  <div class="timeline-step-inner">
                    <div class="timeline-step-marker"></div>
                    <div class="timeline-step-label"><%= statusTranslations[status] || status %></div>
                  </div>
                </li>
              <% }) %>
            </ul>
          </div>
          <% if (order.melhorEnvioLabelUrl) { %>
            <div style="margin-top: 1rem; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; background-color: var(--bg-alt);">
              <span class="label">Etiqueta Melhor Envio:</span>
              <a href="<%= order.melhorEnvioLabelUrl %>" target="_blank" class="primary-link">Baixar Etiqueta</a>
              <% if (order.melhorEnvioTrackingUrl) { %>
                <span class="label" style="margin-left: 20px;">Rastreamento:</span>
                <a href="<%= order.melhorEnvioTrackingUrl %>" target="_blank" class="value"><%= order.trackingCode || 'Ver Rastreamento' %></a>
              <% } %>
            </div>
          <% } %>
        </div>
      <% }) %>
    <% } else { %>
      <div class="panel" style="background:var(--bg-surface); padding:20px; border-radius:12px; border:1px solid var(--border)">
        <p>Você ainda não vendeu nenhum item.</p>
      </div>
    <% } %>
  </div>

</main>
<%- include('../partials/footer') %>

<div id="shipping-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2>Informar Código de Rastreio</h2>
    <form id="shipping-form">
      <input type="hidden" id="order-id-input" name="orderId">
      <div class="form-group">
        <label for="tracking-code-input">Código de Rastreio</label>
        <input type="text" id="tracking-code-input" name="trackingCode" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-primary">Salvar</button>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById('shipping-modal');

  if (modal) {
    const closeBtn = modal.querySelector('.close-btn');
    const shippingForm = document.getElementById('shipping-form');
    const orderIdInput = document.getElementById('order-id-input');
    const trackingCodeInput = document.getElementById('tracking-code-input');

    document.querySelectorAll('.mark-as-shipped-btn').forEach(button => {
      button.addEventListener('click', (event) => {
        const orderId = event.target.dataset.orderId;
        if (orderIdInput) orderIdInput.value = orderId;
        modal.style.display = 'block';
      });
    });

    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
      });
    }

    if (shippingForm) {
      shippingForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const orderId = orderIdInput ? orderIdInput.value : null;
        const trackingCode = trackingCodeInput ? trackingCodeInput.value : null;

        if (!orderId || !trackingCode) {
          window.showToast('Erro: ID do pedido ou código de rastreio faltando.', 'error');
          return;
        }

        try {
          const response = await fetch(`/pedidos-vendidos/${orderId}/marcar-enviado`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ trackingCode })
          });

          if (response.ok) {
            location.reload();
          } else {
            const errorData = await response.json();
            window.showToast(errorData.message || 'Ocorreu um problema.', 'error');
          }
        } catch (error) {
          console.error('Erro ao marcar como enviado:', error);
          window.showToast('Erro de conexão ao marcar como enviado.', 'error');
        }
      });
    }
  }

  document.querySelectorAll('.generate-label-btn').forEach(button => {
    button.addEventListener('click', async (event) => {
      const orderId = event.target.dataset.orderId;
      event.target.disabled = true;
      event.target.textContent = 'Gerando...';

      try {
        const response = await fetch(`/seller/orders/${orderId}/generate-label`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });

        if (response.ok) {
          const data = await response.json();
          window.showToast(data.message || 'Etiqueta gerada com sucesso!', 'success');
          // Give toast time to show before reloading
          setTimeout(() => location.reload(), 1500);
        } else {
          const errorData = await response.json();
          window.showToast(errorData.message || 'Não foi possível gerar a etiqueta.', 'error');
          event.target.disabled = false;
          event.target.textContent = 'Gerar Etiqueta ME';
        }
      } catch (error) {
        console.error('Erro ao gerar etiqueta:', error);
        window.showToast('Erro de conexão ao gerar etiqueta.', 'error');
        event.target.disabled = false;
        event.target.textContent = 'Gerar Etiqueta ME';
      }
    });
  });
});
</script>

<div id="toast-notification" class="toast-notification"></div>

</body>
