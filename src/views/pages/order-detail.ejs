<%- include('../partials/header') %>
<style>
  .order-card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
  }
  .order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
  }
  .order-id {
    font-weight: 600;
    font-size: 1.1rem;
  }
  .order-date {
    color: var(--text-muted);
    font-size: 0.9rem;
  }
  .order-status {
    background-color: rgba(var(--accent-primary-rgb), 0.2);
    color: var(--accent-primary);
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
  }
  .order-body {
    padding-top: 1rem;
  }
  .item-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .order-item {
    display: flex;
    gap: 1rem;
    align-items: center;
  }
  .item-thumb {
    width: 60px;
    height: 84px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid var(--border);
  }
  .item-info {
    flex: 1;
  }
  .item-name {
    font-weight: 600;
  }
  .item-meta {
    font-size: 0.9rem;
    color: var(--text-muted);
  }
  .item-price {
    font-weight: 600;
    text-align: right;
  }
  .order-footer {
    padding-top: 1rem;
    margin-top: 1rem;
    border-top: 1px solid var(--border);
  }
  .address-section {
    margin-top: 1rem;
  }
  .timeline {
    display: flex;
    justify-content: space-between;
    list-style: none;
    padding: 1rem 0;
    margin: 1rem 0;
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
  }
  .timeline-item {
    flex: 1;
    text-align: center;
    position: relative;
    color: var(--text-muted);
  }
  .timeline-item::before {
    content: '';
    position: absolute;
    top: 50%;
    left: -50%;
    width: 100%;
    height: 2px;
    background-color: var(--border);
    z-index: -1;
  }
  .timeline-item:first-child::before {
    content: none;
  }
  .timeline-item.completed::before, .timeline-item.active::before {
    background-color: var(--accent-primary);
  }
  .timeline-item .dot {
    width: 16px;
    height: 16px;
    background-color: var(--border);
    border-radius: 50%;
    display: inline-block;
    margin-bottom: 0.5rem;
  }
  .timeline-item.completed .dot, .timeline-item.active .dot {
    background-color: var(--accent-primary);
  }
  .timeline-item.active {
    color: var(--accent-primary);
    font-weight: bold;
  }
  .back-link {
    color: var(--text-secondary);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: color 0.2s ease, transform 0.2s ease;
  }
  .back-link:hover {
    color: var(--accent-primary);
    transform: translateX(-3px);
  }
</style>

<main class="container" style="max-width: 880px; margin-top: 24px;">
  <%- include('../partials/navbar') %>

  <div style="margin: 24px 0 16px;">
    <a href="/meus-pedidos" class="back-link">&larr; Voltar para Meus Pedidos</a>
  </div>

  <% if (order) { %>
    <% 
      const statusTranslations = {
        'PendingPayment': 'Pagamento Pendente',
        'Paid': 'Pago',
        'Shipped': 'Enviado',
        'Delivered': 'Entregue',
        'Cancelled': 'Cancelado',
        'Processing': 'Processando',
      };
      const translatedStatus = statusTranslations[order.status] || order.status;
    %>
    <div class="order-status-highlight" style="background-color: var(--accent-primary); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center; font-weight: bold;">
      Status: <%= translatedStatus %>
    </div>
    <div class="order-card">
      <div class="order-header">
        <div>
          <div class="order-id">Detalhes do Pedido #<strong style="color: var(--accent-primary);"><%= order._id.toString().slice(-6) %></strong></div>
          <div class="order-date"><%= new Date(order.createdAt).toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' }) %></div>
        </div>
        <div class="order-status">
          <%= translatedStatus %>
        </div>
        <% if (order.trackingCode) { %>
          <div class="tracking-code-display">C√≥digo de Rastreio: <%= order.trackingCode %></div>
        <% } %>
        <% if (order.status === 'Shipped') { %>
          <form action="/meus-pedidos/<%= order._id %>/confirmar-recebimento" method="POST">
            <button type="submit" class="btn btn-success">Confirmar Recebimento</button>
          </form>
        <% } %>
      </div>

      <% 
        const stages = ['PendingPayment', 'Paid', 'Shipped', 'Delivered'];
        const currentStageIndex = stages.indexOf(order.status);
      %>
      <ul class="timeline">
        <% stages.forEach((stage, index) => { %>
          <% 
            let statusClass = '';
            if (index < currentStageIndex) {
              statusClass = 'completed';
            } else if (index === currentStageIndex) {
              statusClass = 'active';
            }
          %>
          <li class="timeline-item <%= statusClass %>">
            <div class="dot"></div>
            <div><%= statusTranslations[stage] || stage %></div>
          </li>
        <% }) %>
      </ul>

      <div class="order-body">
        <h3 id="items-to-review" style="margin-top: 1rem; margin-bottom: 1rem;">Itens do Pedido</h3>
        <ul class="item-list">
          <% order.items.forEach(item => { %>
            <li class="order-item">
              <% if (item.card && item.card.imageUrl) { %>
                <img src="<%= item.card.imageUrl %>" alt="<%= item.cardName %>" class="item-thumb">
              <% } %>
              <div class="item-info">
                <div class="item-name"><%= item.cardName %></div>
                <div class="item-meta">Vendido por: <%= item.sellerName %></div>
                <div class="item-meta">Qtd: <%= item.quantity %></div>
              </div>
                                <div class="item-price"><%= formatPrice(item.price * item.quantity) %></div>
                                <% if (order.status === 'Delivered' && !item.isReviewed) { %>
                                  <a href="/avaliar/<%= order._id %>/<%= item._id %>" class="btn btn-sm btn-primary">Avaliar</a>
                                <% } %>            </li>
          <% }) %>
        </ul>
      </div>

      <div class="order-footer">
        <div class="address-section">
          <h4 style="margin-bottom: 0.5rem;">Endere√ßo de Entrega</h4>
          <div class="address-details" style="color: var(--text-muted);">
            <p style="margin: 0;"><span style="color: var(--accent-primary);">üè† Rua:</span> <%= order.shippingAddress.street %>, <span style="color: var(--accent-primary);">N√∫mero:</span> <%= order.shippingAddress.number %></p>
            <% if (order.shippingAddress.complement) { %>
                <p style="margin: 0;"><span style="color: var(--accent-primary);">üè¢ Complemento:</span> <%= order.shippingAddress.complement %></p>
            <% } %>
            <p style="margin: 0;"><span style="color: var(--accent-primary);">üìç Bairro:</span> <%= order.shippingAddress.neighborhood %></p>
            <p style="margin: 0;"><span style="color: var(--accent-primary);">üèôÔ∏è Cidade:</span> <%= order.shippingAddress.city %> - <span style="color: var(--accent-primary);">Estado:</span> <%= order.shippingAddress.state %></p>
            <p style="margin: 0;"><span style="color: var(--accent-primary);">üìÆ CEP:</span> <%= order.shippingAddress.cep %></p>
          </div>
        </div>
        <div style="text-align: right; margin-top: 1.5rem;">
          <div>Subtotal: <strong><%= formatPrice(order.totals.subtotal) %></strong></div>
          <div>Frete: <strong><%= formatPrice(order.totals.shipping) %></strong></div>
          <div>Taxa do Marketplace: <strong><%= formatPrice(order.totals.marketplaceFee) %></strong></div>
          <div style="font-size: 1.2rem; margin-top: 8px;">Total: <strong style="color: var(--accent-primary); font-size: 1.5rem;"><%= formatPrice(order.totals.grand) %></strong></div>
        </div>
      </div>

    </div>
  <% } else { %>
    <div class="panel" style="background:var(--bg-surface); padding:20px; border-radius:12px; border:1px solid var(--border)">
      <h2>Pedido n√£o encontrado</h2>
      <p>O pedido que voc√™ est√° tentando visualizar n√£o existe ou n√£o pertence a voc√™.</p>
    </div>
  <% } %>

</main>
<%- include('../partials/footer') %>
<script src="/js/main.js"></script>
