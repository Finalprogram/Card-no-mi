<%- include('../../partials/header') %>
<%- include('../../partials/navbar') %>

<link rel="stylesheet" href="/css/forum.css">

<div class="forum-twitter">
  <div class="forum-twitter-grid">
    <aside class="forum-side left">
      <div class="forum-brand">
        <i class="fas fa-comments"></i>
        <span class="nav-text">Fórum Card no Mi</span>
      </div>
      <nav class="forum-nav">
        <a href="/forum" class="forum-nav-link active"><i class="fas fa-home"></i><span class="nav-text">Início</span></a>
        <a href="/forum/search" class="forum-nav-link"><i class="fas fa-search"></i><span class="nav-text">Buscar</span></a>
        <a href="/forum/leaderboard" class="forum-nav-link"><i class="fas fa-trophy"></i><span class="nav-text">Ranking</span></a>
        <% if (user) { %>
          <a href="/forum/user/<%= user.username %>" class="forum-nav-link"><i class="fas fa-user"></i><span class="nav-text">Meu Perfil</span></a>
          <a href="/forum/notifications" class="forum-nav-link"><i class="fas fa-bell"></i><span class="nav-text">Notificações</span></a>
        <% } else { %>
          <a href="/auth/login" class="forum-nav-link"><i class="fas fa-sign-in-alt"></i><span class="nav-text">Entrar</span></a>
        <% } %>
      </nav>
      <a href="<%= (categories && categories.length > 0) ? ('/forum/' + categories[0].slug + '/new') : '/forum' %>" class="forum-create-btn"><i class="fas fa-plus"></i><span class="nav-text">Criar tópico</span></a>
    </aside>

    <main class="forum-feed">
      <header class="forum-feed-header">
        <h1>Fórum</h1>
        <p>Participe das discussões, compartilhe estratégias e conecte-se com a comunidade.</p>
      </header>

      <section class="forum-composer">
        <div class="composer-avatar">
          <img src="<%= user && user.avatar ? user.avatar : '/images/default-avatar.png' %>" alt="avatar">
        </div>
        <div class="composer-box">
          <p>Tem algo para compartilhar?</p>
          <div class="composer-actions">
            <a href="<%= (categories && categories.length > 0) ? ('/forum/' + categories[0].slug + '/new') : '/forum' %>" class="btn btn-primary">Novo tópico</a>
          </div>
        </div>
      </section>

      <section class="forum-feed-list">
        <% categories.forEach(category => { %>
          <article class="forum-thread-card">
            <div class="thread-card-icon" style="background: <%= category.color %>20; color: <%= category.color %>"><%= category.icon %></div>
            <div class="thread-card-body">
              <a href="/forum/<%= category.slug %>" class="thread-card-title"><%= category.name %></a>
              <p class="thread-card-desc"><%= category.description %></p>
              <div class="thread-card-meta">
                <span><i class="fas fa-comments"></i> <%= category.threadCount || 0 %> tópicos</span>
                <span><i class="fas fa-comment-dots"></i> <%= category.postCount || 0 %> posts</span>
              </div>
            </div>
            <div class="thread-card-activity">
              <% if (category.lastThread) { %>
                <a href="/forum/<%= category.slug %>/<%= category.lastThread.slug %>" class="activity-title">
                  <%= category.lastThread.title.substring(0, 40) %><%= category.lastThread.title.length > 40 ? '...' : '' %>
                </a>
                <span class="activity-time">
                  <%= new Date(category.lastThread.lastActivity).toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' }) %>
                </span>
              <% } else { %>
                <span class="activity-empty">Sem atividade</span>
              <% } %>
            </div>
          </article>
        <% }) %>
      </section>
    </main>

    <aside class="forum-side right">
      <div class="forum-widget trends-widget">
        <h3>Trends</h3>
        <% const trendThreadsSafe = trendThreads || []; %>
        <div class="trend-list">
          <% trendThreadsSafe.forEach(thread => { %>
            <a class="trend-item" href="/forum/<%= thread.category ? thread.category.slug : '' %>/<%= thread.slug %>">
              <span class="trend-label"><%= thread.title %></span>
            </a>
          <% }) %>
          <% if (!trendThreadsSafe.length) { %>
            <div class="trend-empty">Sem tópicos populares no momento.</div>
          <% } %>
        </div>
      </div>

      <div class="forum-widget">
        <h3>Online agora</h3>
        <% if (onlineUsers && onlineUsers.length > 0) { %>
          <div class="online-users">
            <% onlineUsers.forEach(onlineUser => { %>
              <a href="/forum/user/<%= onlineUser.username %>" class="online-user" title="<%= onlineUser.username %>">
                <img src="<%= onlineUser.avatar || '/images/default-avatar.png' %>" alt="<%= onlineUser.username %>" class="online-avatar">
                <span class="online-name"><%= onlineUser.username %></span>
              </a>
            <% }) %>
          </div>
        <% } else { %>
          <p class="online-empty">Nenhum usuário online agora.</p>
        <% } %>
      </div>

      <div class="forum-widget">
        <h3>Resumo</h3>
        <div class="forum-summary">
          <div><strong><%= categories.reduce((sum, cat) => sum + (cat.threadCount || 0), 0) %></strong> tópicos</div>
          <div><strong><%= categories.reduce((sum, cat) => sum + (cat.postCount || 0), 0) %></strong> posts</div>
          <div><strong><%= totalUsers || 0 %></strong> membros</div>
          <div><strong><%= onlineUsersCount || 0 %></strong> online</div>
        </div>
      </div>
    </aside>
  </div>
</div>

<%- include('../../partials/footer') %>