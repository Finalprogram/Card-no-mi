<%- include('../../partials/header') %>
<%- include('../../partials/navbar') %>

<link rel="stylesheet" href="/css/forum.css">

<div class="forum-container thread-page">
  <!-- Breadcrumb -->
  <div class="forum-breadcrumb">
    <a href="/forum"><i class="fas fa-home"></i> F√≥rum</a>
    <span class="separator">/</span>
    <a href="/forum/<%= thread.category.slug %>">
      <%= thread.category.icon %> <%= thread.category.name %>
    </a>
    <span class="separator">/</span>
    <span class="current"><%= thread.title %></span>
  </div>

  <!-- Thread Principal -->
  <div class="thread-main">
    <!-- Status Badges -->
    <div class="thread-badges">
      <% if (thread.isPinned) { %>
        <span class="badge badge-pinned">
          <i class="fas fa-thumbtack"></i> Fixado
        </span>
      <% } %>
      <% if (thread.isLocked) { %>
        <span class="badge badge-locked">
          <i class="fas fa-lock"></i> Bloqueado
        </span>
      <% } %>
      <% if (!thread.isActive && user && user.role === 'admin') { %>
        <span class="badge badge-inactive">
          <i class="fas fa-eye-slash"></i> Inativo (vis√≠vel apenas para admins)
        </span>
      <% } %>
    </div>

    <!-- T√≠tulo -->
    <h1 class="thread-main-title"><%= thread.title %></h1>

    <!-- Tags -->
    <% if (thread.tags && thread.tags.length > 0) { %>
      <div class="thread-main-tags">
        <% thread.tags.forEach(tag => { %>
          <a href="/forum/<%= thread.category.slug %>?tag=<%= tag %>" class="tag">#<%= tag %></a>
        <% }) %>
      </div>
    <% } %>

    <!-- Autor e Conte√∫do -->
    <div class="post-container op-post">
      <div class="post-author-info">
        <a href="/forum/user/<%= thread.author.username %>">
          <img src="<%= thread.author.avatar || '/images/default-avatar.png' %>" 
               alt="<%= thread.author.username %>"
               class="author-avatar-large">
        </a>
        <div class="author-details">
          <a href="/forum/user/<%= thread.author.username %>" class="author-name">
            <%= thread.author.username %>
            <% if (thread.author.role === 'admin') { %>
              <span class="user-badge admin-badge" title="Administrador"><i class="fas fa-crown"></i> Admin</span>
            <% } else if (thread.author.role === 'moderator') { %>
              <span class="user-badge mod-badge" title="Moderador"><i class="fas fa-shield-alt"></i> Mod</span>
            <% } %>
          </a>
          <% if (thread.author.reputation) { %>
            <div class="author-reputation">
              <span class="rep-title"><%= thread.author.reputation.title %></span>
              <span class="rep-level">N√≠vel <%= thread.author.reputation.level %></span>
              <div class="rep-badges">
                <% thread.author.reputation.badges.slice(0, 3).forEach(badge => { %>
                  <span class="badge-icon" title="<%= badge.description %>"><%= badge.icon %></span>
                <% }) %>
              </div>
            </div>
          <% } %>
          <div class="author-stats">
            <span><i class="fas fa-comments"></i> <%= thread.author.reputation?.stats.postsCreated || 0 %> posts</span>
            <span><i class="fas fa-calendar-alt"></i> Membro desde <%= new Date(thread.author.createdAt).toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' }) %></span>
          </div>
        </div>
      </div>

      <div class="post-content-area">
        <div class="post-date">
          <i class="far fa-clock"></i>
          <%= new Date(thread.createdAt).toLocaleString('pt-BR', {
            day: 'numeric',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }) %>
        </div>

        <div class="post-content">
          <%- thread.content.replace(/\n/g, '<br>') %>
        </div>

        <!-- Rea√ß√µes da Thread -->
        <div class="post-reactions">
          <div class="reactions-display">
            <% 
              const reactionEmojis = {
                like: 'üëç',
                love: '‚ù§Ô∏è',
                wow: 'üòÆ',
                haha: 'üòÇ',
                sad: 'üò¢',
                angry: 'üò°'
              };
              const reactionCounts = {};
              thread.reactions.forEach(r => {
                reactionCounts[r.type] = (reactionCounts[r.type] || 0) + 1;
              });
            %>
            <% Object.keys(reactionCounts).forEach(type => { %>
              <span class="reaction-count">
                <%= reactionEmojis[type] %> <%= reactionCounts[type] %>
              </span>
            <% }) %>
          </div>

          <% if (user) { %>
            <div class="reactions-buttons">
              <% 
                const currentUserId = (user._id || user.id).toString();
              %>
              <% Object.keys(reactionEmojis).forEach(type => { %>
                <button class="reaction-btn <%= thread.reactions.find(r => r.user.toString() === currentUserId && r.type === type) ? 'active' : '' %>"
                        onclick="reactToThread('<%= thread._id %>', '<%= type %>')">
                  <%= reactionEmojis[type] %>
                </button>
              <% }) %>
            </div>
          <% } %>
        </div>

        <div class="post-actions">
          <button class="btn-action" onclick="showReplyForm(null, '<%= thread.author.username %>')">
            <i class="fas fa-reply"></i> Responder
          </button>
          <button class="btn-action" onclick="quotePost(null, `<%= thread.content.substring(0, 200).replace(/'/g, "\\'") %>`)">
            <i class="fas fa-quote-left"></i> Citar
          </button>
          <% 
            const userId = user ? (user._id || user.id) : null;
            const authorId = thread.author._id || thread.author.id;
            const isAuthor = userId && authorId && userId.toString() === authorId.toString();
            const isModerator = user && (user.role === 'moderator' || user.role === 'admin');
          %>
          <% if (isAuthor) { %>
            <button class="btn-action">
              <i class="fas fa-edit"></i> Editar
            </button>
          <% } %>
          <% if (user && !isAuthor) { %>
            <button class="btn-action btn-report" onclick="reportThread('<%= thread._id %>')">
              <i class="fas fa-flag"></i> Reportar
            </button>
          <% } %>
          <% if (isModerator) { %>
            <div class="mod-actions-inline">
              <button class="btn-action btn-mod" onclick="toggleThreadPin('<%= thread._id %>')">
                <i class="fas fa-thumbtack"></i> <%= thread.isPinned ? 'Desafixar' : 'Fixar' %>
              </button>
              <button class="btn-action btn-mod" onclick="toggleThreadLock('<%= thread._id %>')">
                <i class="fas fa-lock"></i> <%= thread.isLocked ? 'Desbloquear' : 'Bloquear' %>
              </button>
              <% if (user.role === 'admin') { %>
                <button class="btn-action btn-mod-warning" onclick="toggleThreadActive('<%= thread._id %>')">
                  <i class="fas fa-eye-slash"></i> <%= thread.isActive ? 'Inativar' : 'Ativar' %>
                </button>
              <% } %>
              <button class="btn-action btn-mod-danger" onclick="deleteThread('<%= thread._id %>')">
                <i class="fas fa-trash"></i> Deletar Thread
              </button>
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Estat√≠sticas -->
    <div class="thread-stats-bar">
      <span><i class="fas fa-eye"></i> <%= thread.viewCount %> visualiza√ß√µes</span>
      <span><i class="fas fa-comments"></i> <%= posts.length %> respostas</span>
      <span><i class="fas fa-heart"></i> <%= thread.reactions.length %> rea√ß√µes</span>
    </div>
  </div>

  <!-- Posts/Respostas -->
  <div class="posts-section reddit-style">
    <h2 class="section-title">
      <i class="fas fa-comments"></i>
      Respostas (<%= totalPosts %>)
    </h2>

    <% if (posts.length === 0) { %>
      <div class="no-posts">
        <i class="fas fa-comment-slash fa-3x"></i>
        <p>Nenhuma resposta ainda. Seja o primeiro a comentar!</p>
      </div>
    <% } else { %>
      <% posts.forEach(post => { %>
        <%- include('../../partials/reddit-comment', { post, depth: 0, user }) %>
      <% }) %>
    <% } %>
  </div>

  <!-- Modal de Report -->
  <div id="reportModal" class="report-modal" style="display: none;">
    <div class="report-modal-content">
      <div class="report-modal-header">
        <h3><i class="fas fa-flag"></i> Reportar Conte√∫do</h3>
        <button class="report-modal-close" onclick="closeReportModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="report-modal-body">
        <p>Por que voc√™ est√° reportando este conte√∫do?</p>
        <select id="reportReasonSelect" class="report-select">
          <option value="">Selecione um motivo...</option>
          <option value="Conte√∫do ofensivo">Conte√∫do ofensivo</option>
          <option value="Spam ou propaganda">Spam ou propaganda</option>
          <option value="Discurso de √≥dio">Discurso de √≥dio</option>
          <option value="Informa√ß√£o falsa">Informa√ß√£o falsa</option>
          <option value="Ass√©dio ou bullying">Ass√©dio ou bullying</option>
          <option value="Conte√∫do sexual inapropriado">Conte√∫do sexual inapropriado</option>
          <option value="Viola√ß√£o das regras">Viola√ß√£o das regras</option>
          <option value="Outro">Outro motivo</option>
        </select>
        <textarea id="reportReasonText" class="report-textarea" placeholder="Descreva o problema (opcional, mas recomendado)..." rows="4"></textarea>
        <input type="hidden" id="reportTargetId">
        <input type="hidden" id="reportTargetType">
      </div>
      <div class="report-modal-footer">
        <button class="btn-cancel" onclick="closeReportModal()">Cancelar</button>
        <button class="btn-submit-report" onclick="submitReport()">
          <i class="fas fa-paper-plane"></i> Enviar Report
        </button>
      </div>
    </div>
  </div>

  <!-- Formul√°rio de Resposta -->
  <% if (user && !thread.isLocked) { %>
    <div class="reply-form" id="replyForm">
      <h3 class="form-title">
        <i class="fas fa-reply"></i>
        Responder √† Thread
      </h3>
      <form id="postForm">
        <input type="hidden" id="parentPostId" name="parentPostId">
        <input type="hidden" id="quotedPostId" name="quotedPostId">
        
        <div id="replyingTo" class="replying-to" style="display: none;">
          Respondendo a <strong id="replyingToUser"></strong>
          <button type="button" onclick="cancelReply()" class="btn-cancel-reply">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div id="quotedContent" class="quoted-preview" style="display: none;"></div>

        <textarea id="postContent" name="content" rows="6" placeholder="Digite sua resposta..." required></textarea>
        
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane"></i> Enviar Resposta
          </button>
        </div>
      </form>
    </div>
  <% } else if (thread.isLocked) { %>
    <div class="thread-locked-notice">
      <i class="fas fa-lock fa-2x"></i>
      <p>Esta thread est√° bloqueada e n√£o aceita mais respostas.</p>
    </div>
  <% } else { %>
    <div class="login-prompt">
      <i class="fas fa-sign-in-alt fa-2x"></i>
      <p>Voc√™ precisa estar logado para responder.</p>
      <a href="/auth/login?redirect=<%= encodeURIComponent(`/forum/${thread.category.slug}/${thread.slug}`) %>" class="btn btn-primary">
        Fazer Login
      </a>
    </div>
  <% } %>

</div>

<script>
let currentReplyTo = null;
let currentQuotedPost = null;

function showReplyForm(postId, username) {
  currentReplyTo = postId;
  document.getElementById('parentPostId').value = postId || '';
  document.getElementById('replyingToUser').textContent = username;
  document.getElementById('replyingTo').style.display = 'flex';
  document.getElementById('postContent').focus();
  document.getElementById('replyForm').scrollIntoView({ behavior: 'smooth' });
}

function cancelReply() {
  currentReplyTo = null;
  document.getElementById('parentPostId').value = '';
  document.getElementById('replyingTo').style.display = 'none';
}

function toggleReplies(postId) {
  const repliesDiv = document.getElementById('replies-' + postId);
  const btn = event.target.closest('.collapse-btn');
  if (repliesDiv.style.display === 'none') {
    repliesDiv.style.display = 'block';
    btn.innerHTML = '<i class="fas fa-minus-square"></i> Ocultar respostas';
  } else {
    repliesDiv.style.display = 'none';
    btn.innerHTML = '<i class="fas fa-plus-square"></i> Mostrar respostas';
  }
}

async function votePost(postId, voteType) {
  try {
    const response = await fetch(`/forum/post/${postId}/vote`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ voteType })
    });
    const data = await response.json();
    if (data.success) {
      location.reload();
    }
  } catch (error) {
    console.error('Erro ao votar:', error);
  }
}

function quotePost(postId, content) {
  currentQuotedPost = postId;
  document.getElementById('quotedPostId').value = postId || '';
  document.getElementById('quotedContent').innerHTML = '<i class="fas fa-quote-left"></i> ' + content;
  document.getElementById('quotedContent').style.display = 'block';
  document.getElementById('postContent').focus();
  document.getElementById('replyForm').scrollIntoView({ behavior: 'smooth' });
}

async function reactToThread(threadId, reactionType) {
  try {
    const response = await fetch(`/forum/thread/${threadId}/react`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reactionType })
    });
    const data = await response.json();
    if (data.success) {
      location.reload();
    }
  } catch (error) {
    console.error('Erro ao reagir:', error);
  }
}

async function reactToPost(postId, reactionType) {
  try {
    const response = await fetch(`/forum/post/${postId}/react`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reactionType })
    });
    const data = await response.json();
    if (data.success) {
      location.reload();
    }
  } catch (error) {
    console.error('Erro ao reagir:', error);
  }
}

document.getElementById('postForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const content = document.getElementById('postContent').value;
  const parentPostId = document.getElementById('parentPostId').value;
  const quotedPostId = document.getElementById('quotedPostId').value;

  try {
    const response = await fetch(window.location.pathname + '/reply', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content, parentPostId, quotedPostId })
    });
    
    const data = await response.json();
    if (data.success) {
      location.reload();
    } else {
      alert(data.message || 'Erro ao enviar resposta');
    }
  } catch (error) {
    console.error('Erro ao enviar resposta:', error);
    alert('Erro ao enviar resposta');
  }
});

// Fun√ß√µes de Modera√ß√£o nos Posts
function toggleModMenu(postId) {
  const menu = document.getElementById('mod-menu-' + postId);
  // Fecha todos os outros menus
  document.querySelectorAll('.mod-dropdown').forEach(m => {
    if (m.id !== 'mod-menu-' + postId) m.style.display = 'none';
  });
  menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

async function deletePostMod(postId) {
  if (!confirm('Tem certeza que deseja deletar este post?')) return;
  
  try {
    const response = await fetch(`/forum/moderation/post/${postId}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    });
    
    const data = await response.json();
    if (data.success) {
      alert('Post deletado com sucesso!');
      location.reload();
    } else {
      alert(data.message || 'Erro ao deletar post');
    }
  } catch (error) {
    console.error('Erro ao deletar post:', error);
    alert('Erro ao deletar post');
  }
}

async function togglePostActive(postId) {
  try {
    const response = await fetch(`/forum/moderation/post/${postId}/toggle-active`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    const data = await response.json();
    if (data.success) {
      alert(data.message);
      location.reload();
    } else {
      alert(data.message || 'Erro ao inativar/ativar post');
    }
  } catch (error) {
    console.error('Erro ao inativar/ativar post:', error);
    alert('Erro ao inativar/ativar post');
  }
}

// Fechar menu ao clicar fora
document.addEventListener('click', function(event) {
  if (!event.target.closest('.comment-mod-menu')) {
    document.querySelectorAll('.mod-dropdown').forEach(m => m.style.display = 'none');
  }
});

// Fechar modal ao clicar fora
document.getElementById('reportModal')?.addEventListener('click', function(event) {
  if (event.target === this) {
    closeReportModal();
  }
});

// Fechar modal com tecla ESC
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeReportModal();
  }
});

// Fun√ß√µes de Modera√ß√£o da Thread
async function toggleThreadPin(threadId) {
  try {
    const response = await fetch(`/forum/moderation/thread/${threadId}/pin`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    const data = await response.json();
    if (data.success) {
      alert(data.message);
      location.reload();
    } else {
      alert(data.message || 'Erro ao fixar/desafixar thread');
    }
  } catch (error) {
    console.error('Erro ao fixar/desafixar thread:', error);
    alert('Erro ao fixar/desafixar thread');
  }
}

async function toggleThreadLock(threadId) {
  try {
    const response = await fetch(`/forum/moderation/thread/${threadId}/lock`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    const data = await response.json();
    if (data.success) {
      alert(data.message);
      location.reload();
    } else {
      alert(data.message || 'Erro ao bloquear/desbloquear thread');
    }
  } catch (error) {
    console.error('Erro ao bloquear/desbloquear thread:', error);
    alert('Erro ao bloquear/desbloquear thread');
  }
}

async function deleteThread(threadId) {
  if (!confirm('Tem certeza que deseja deletar esta thread? Esta a√ß√£o n√£o pode ser desfeita.')) {
    return;
  }
  
  try {
    const response = await fetch(`/forum/moderation/thread/${threadId}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    });
    
    const data = await response.json();
    if (data.success) {
      alert('Thread deletada com sucesso!');
      window.location.href = '/forum';
    } else {
      alert(data.message || 'Erro ao deletar thread');
    }
  } catch (error) {
    console.error('Erro ao deletar thread:', error);
    alert('Erro ao deletar thread');
  }
}

async function toggleThreadActive(threadId) {
  try {
    const response = await fetch(`/forum/moderation/thread/${threadId}/toggle-active`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    const data = await response.json();
    if (data.success) {
      alert(data.message);
      location.reload();
    } else {
      alert(data.message || 'Erro ao inativar/ativar thread');
    }
  } catch (error) {
    console.error('Erro ao inativar/ativar thread:', error);
    alert('Erro ao inativar/ativar thread');
  }
}

function reportThread(threadId) {
  document.getElementById('reportTargetId').value = threadId;
  document.getElementById('reportTargetType').value = 'thread';
  document.getElementById('reportReasonSelect').value = '';
  document.getElementById('reportReasonText').value = '';
  document.getElementById('reportModal').style.display = 'flex';
}

function reportPost(postId) {
  document.getElementById('reportTargetId').value = postId;
  document.getElementById('reportTargetType').value = 'post';
  document.getElementById('reportReasonSelect').value = '';
  document.getElementById('reportReasonText').value = '';
  document.getElementById('reportModal').style.display = 'flex';
}

function closeReportModal() {
  document.getElementById('reportModal').style.display = 'none';
}

async function submitReport() {
  const targetId = document.getElementById('reportTargetId').value;
  const targetType = document.getElementById('reportTargetType').value;
  const reasonSelect = document.getElementById('reportReasonSelect').value;
  const reasonText = document.getElementById('reportReasonText').value;
  
  if (!reasonSelect) {
    alert('Por favor, selecione um motivo para o report.');
    return;
  }
  
  let fullReason = reasonSelect;
  if (reasonText.trim()) {
    fullReason += ': ' + reasonText.trim();
  }
  
  if (fullReason.length < 5) {
    alert('Por favor, forne√ßa mais detalhes sobre o motivo do report.');
    return;
  }
  
  try {
    const url = targetType === 'thread' 
      ? `/forum/moderation/thread/${targetId}/flag`
      : `/forum/moderation/post/${targetId}/flag`;
    
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reason: fullReason })
    });
    
    const data = await response.json();
    if (data.success) {
      closeReportModal();
      showNotification('‚úÖ Report enviado com sucesso! Nossa equipe de modera√ß√£o ir√° analisar.', 'success');
    } else {
      alert(data.message || 'Erro ao enviar report');
    }
  } catch (error) {
    console.error('Erro ao enviar report:', error);
    alert('Erro ao enviar report. Por favor, tente novamente.');
  }
}

function showNotification(message, type) {
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.innerHTML = message;
  notification.style.cssText = `
    position: fixed;
    top: 100px;
    right: 20px;
    background: ${type === 'success' ? '#10b981' : '#ef4444'};
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    animation: slideIn 0.3s ease;
  `;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}
</script>

<%- include('../../partials/footer') %>
