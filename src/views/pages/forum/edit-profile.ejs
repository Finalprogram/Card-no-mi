<%- include('../../partials/header') %>
<%- include('../../partials/navbar') %>

<link rel="stylesheet" href="/css/forum.css">

<div class="forum-container">
  <!-- Breadcrumb -->
  <div class="forum-breadcrumb">
    <a href="/forum"><i class="fas fa-home"></i> Fórum</a>
    <span class="separator">/</span>
    <a href="/forum/user/<%= profileUser.username %>">Perfil</a>
    <span class="separator">/</span>
    <span class="current">Editar Perfil</span>
  </div>

  <!-- Header -->
  <div class="edit-profile-header">
    <h1><i class="fas fa-user-edit"></i> Editar Perfil</h1>
    <p>Personalize seu perfil no fórum</p>
  </div>

  <!-- Avatar Section -->
  <div class="profile-section">
    <h2 class="section-title"><i class="fas fa-image"></i> Avatar</h2>
    <div class="avatar-upload-section">
      <div class="avatar-preview">
        <img id="avatarPreview" 
             src="<%= profileUser.avatar || '/images/default-avatar.png' %>" 
             alt="Avatar"
             onerror="this.src='/images/default-avatar.png'">
      </div>
      <div class="avatar-upload-controls">
        <input type="file" id="avatarInput" accept="image/*" style="display: none;">
        <button type="button" class="btn btn-primary" onclick="document.getElementById('avatarInput').click()">
          <i class="fas fa-upload"></i> Escolher Imagem
        </button>
        <p class="help-text">Tamanho máximo: 2MB. Formatos: JPG, PNG, GIF, WEBP</p>
      </div>
    </div>
  </div>

  <!-- Profile Form -->
  <form id="profileForm" class="profile-form">
    <!-- Título Personalizado -->
    <div class="form-group">
      <label for="forumTitle">
        <i class="fas fa-medal"></i> Título Personalizado
      </label>
      <input type="text" 
             id="forumTitle" 
             name="forumTitle" 
             class="form-control" 
             value="<%= profileUser.forumTitle || '' %>"
             maxlength="50"
             placeholder="Ex: Jogador Veterano, Colecionador, Mestre dos Decks">
      <small class="form-text">Máximo 50 caracteres. Aparece abaixo do seu nome.</small>
    </div>

    <!-- Biografia -->
    <div class="form-group">
      <label for="bio">
        <i class="fas fa-align-left"></i> Biografia
      </label>
      <textarea id="bio" 
                name="bio" 
                class="form-control" 
                rows="5" 
                maxlength="500"
                placeholder="Conte um pouco sobre você..."><%= profileUser.bio || '' %></textarea>
      <small class="form-text">Máximo 500 caracteres.</small>
    </div>

    <!-- Assinatura -->
    <div class="form-group">
      <label for="signature">
        <i class="fas fa-signature"></i> Assinatura
      </label>
      <textarea id="signature" 
                name="signature" 
                class="form-control" 
                rows="3" 
                maxlength="200"
                placeholder="Sua assinatura aparece no final de cada post..."><%= profileUser.signature || '' %></textarea>
      <small class="form-text">Máximo 200 caracteres. Aparece no final de cada post.</small>
    </div>

    <!-- Localização -->
    <div class="form-group">
      <label for="location">
        <i class="fas fa-map-marker-alt"></i> Localização
      </label>
      <input type="text" 
             id="location" 
             name="location" 
             class="form-control" 
             value="<%= profileUser.location || '' %>"
             placeholder="Ex: São Paulo, Brasil">
    </div>

    <!-- Website -->
    <div class="form-group">
      <label for="website">
        <i class="fas fa-globe"></i> Website
      </label>
      <input type="url" 
             id="website" 
             name="website" 
             class="form-control" 
             value="<%= profileUser.website || '' %>"
             placeholder="https://seu-site.com">
    </div>

    <!-- Redes Sociais -->
    <h3 class="subsection-title"><i class="fas fa-share-alt"></i> Redes Sociais</h3>
    
    <div class="form-row">
      <div class="form-group col-md-6">
        <label for="twitter">
          <i class="fab fa-twitter"></i> Twitter
        </label>
        <div class="input-group">
          <span class="input-group-text">@</span>
          <input type="text" 
                 id="twitter" 
                 name="twitter" 
                 class="form-control" 
                 value="<%= profileUser.socialLinks && profileUser.socialLinks.twitter || '' %>"
                 placeholder="username">
        </div>
      </div>

      <div class="form-group col-md-6">
        <label for="instagram">
          <i class="fab fa-instagram"></i> Instagram
        </label>
        <div class="input-group">
          <span class="input-group-text">@</span>
          <input type="text" 
                 id="instagram" 
                 name="instagram" 
                 class="form-control" 
                 value="<%= profileUser.socialLinks && profileUser.socialLinks.instagram || '' %>"
                 placeholder="username">
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group col-md-6">
        <label for="youtube">
          <i class="fab fa-youtube"></i> YouTube
        </label>
        <div class="input-group">
          <span class="input-group-text">@</span>
          <input type="text" 
                 id="youtube" 
                 name="youtube" 
                 class="form-control" 
                 value="<%= profileUser.socialLinks && profileUser.socialLinks.youtube || '' %>"
                 placeholder="canal">
        </div>
      </div>

      <div class="form-group col-md-6">
        <label for="twitch">
          <i class="fab fa-twitch"></i> Twitch
        </label>
        <div class="input-group">
          <span class="input-group-text">@</span>
          <input type="text" 
                 id="twitch" 
                 name="twitch" 
                 class="form-control" 
                 value="<%= profileUser.socialLinks && profileUser.socialLinks.twitch || '' %>"
                 placeholder="canal">
        </div>
      </div>
    </div>

    <!-- Buttons -->
    <div class="form-actions">
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-save"></i> Salvar Alterações
      </button>
      <a href="/forum/user/<%= profileUser.username %>" class="btn btn-secondary">
        <i class="fas fa-times"></i> Cancelar
      </a>
    </div>
  </form>
</div>

<%- include('../../partials/footer') %>

<script>
// Avatar upload
document.getElementById('avatarInput').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  // Preview
  const reader = new FileReader();
  reader.onload = function(e) {
    document.getElementById('avatarPreview').src = e.target.result;
  };
  reader.readAsDataURL(file);
  
  // Upload
  const formData = new FormData();
  formData.append('avatar', file);
  
  try {
    const response = await fetch('/forum/profile/avatar', {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    if (data.success) {
      showNotification('Avatar atualizado com sucesso!', 'success');
    } else {
      showNotification(data.message || 'Erro ao fazer upload', 'error');
    }
  } catch (error) {
    console.error('Erro:', error);
    showNotification('Erro ao fazer upload do avatar', 'error');
  }
});

// Profile form submit
document.getElementById('profileForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  
  try {
    const response = await fetch('/forum/profile/edit', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (result.success) {
      showNotification(result.message, 'success');
      if (result.redirect) {
        setTimeout(() => {
          window.location.href = result.redirect;
        }, 1500);
      }
    } else {
      showNotification(result.message || 'Erro ao atualizar perfil', 'error');
    }
  } catch (error) {
    console.error('Erro:', error);
    showNotification('Erro ao atualizar perfil', 'error');
  }
});

function showNotification(message, type) {
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.textContent = message;
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    background: ${type === 'success' ? '#10b981' : '#ef4444'};
    color: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    animation: slideIn 0.3s ease;
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}
</script>

<style>
@keyframes slideIn {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(400px); opacity: 0; }
}
</style>
