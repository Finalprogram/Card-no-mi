<%- include('../../partials/header') %>
<%- include('../../partials/navbar') %>

<link rel="stylesheet" href="/css/moderation-dashboard.css">

<div class="moderation-container">
    <!-- Header Moderno -->
    <div class="moderation-hero">
        <div class="moderation-hero-content">
            <div class="hero-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="hero-text">
                <h1>Painel de Modera√ß√£o</h1>
                <p>Gerencie conte√∫do reportado e mantenha a comunidade segura</p>
            </div>
        </div>
        <div class="hero-actions">
            <a href="/forum/moderation/history" class="hero-btn">
                <i class="fas fa-history"></i> Hist√≥rico
            </a>
            <button class="hero-btn" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Atualizar
            </button>
            <a href="/forum" class="hero-btn hero-btn-outline">
                <i class="fas fa-arrow-left"></i> Voltar ao F√≥rum
            </a>
        </div>
    </div>

    <!-- Estat√≠sticas Modernas -->
    <div class="stats-grid">
        <div class="stat-card stat-danger">
            <div class="stat-header">
                <span class="stat-label">Total de Reports</span>
                <div class="stat-icon">
                    <i class="fas fa-flag"></i>
                </div>
            </div>
            <div class="stat-value"><%= stats.totalFlags %></div>
            <div class="stat-footer">
                <span class="stat-trend <%= stats.totalFlags > 0 ? 'trend-up' : 'trend-neutral' %>">
                    <i class="fas fa-circle"></i> Requer aten√ß√£o
                </span>
            </div>
        </div>

        <div class="stat-card stat-warning">
            <div class="stat-header">
                <span class="stat-label">Threads Reportadas</span>
                <div class="stat-icon">
                    <i class="fas fa-comments"></i>
                </div>
            </div>
            <div class="stat-value"><%= stats.flaggedThreadsCount %></div>
            <div class="stat-footer">
                <span class="stat-trend">
                    <i class="fas fa-comments"></i> <%= flaggedThreads.length %> aguardando
                </span>
            </div>
        </div>

        <div class="stat-card stat-info">
            <div class="stat-header">
                <span class="stat-label">Posts Reportados</span>
                <div class="stat-icon">
                    <i class="fas fa-comment"></i>
                </div>
            </div>
            <div class="stat-value"><%= stats.flaggedPostsCount %></div>
            <div class="stat-footer">
                <span class="stat-trend">
                    <i class="fas fa-comment"></i> <%= flaggedPosts.length %> aguardando
                </span>
            </div>
        </div>

        <div class="stat-card stat-success">
            <div class="stat-header">
                <span class="stat-label">A√ß√µes Hoje</span>
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
            <div class="stat-value"><%= stats.deletedThreadsToday + stats.deletedPostsToday %></div>
            <div class="stat-footer">
                <span class="stat-trend">
                    <i class="fas fa-trash-alt"></i> <%= stats.deletedThreadsToday %> threads, <%= stats.deletedPostsToday %> posts
                </span>
            </div>
        </div>
    </div>

    <!-- Tabs Modernos -->
    <div class="mod-tabs-container">
        <div class="mod-tabs">
            <button class="mod-tab active" data-tab="threads" onclick="switchTab('threads')">
                <i class="fas fa-comments"></i>
                <span>Threads</span>
                <% if (flaggedThreads.length > 0) { %>
                    <span class="tab-badge"><%= flaggedThreads.length %></span>
                <% } %>
            </button>
            <button class="mod-tab" data-tab="posts" onclick="switchTab('posts')">
                <i class="fas fa-comment"></i>
                <span>Posts</span>
                <% if (flaggedPosts.length > 0) { %>
                    <span class="tab-badge"><%= flaggedPosts.length %></span>
                <% } %>
            </button>
        </div>
    </div>

    <!-- Tab Content: Threads -->
    <div id="tab-threads" class="mod-tab-content active">
        <% if (flaggedThreads.length === 0) { %>
            <div class="empty-state-modern">
                <div class="empty-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3>Nenhuma thread reportada</h3>
                <p>Tudo limpo por aqui! Continue o √≥timo trabalho. üéâ</p>
            </div>
        <% } else { %>
            <div class="flagged-list">
                <% flaggedThreads.forEach((thread, index) => { %>
                    <div class="flagged-card" data-id="<%= thread._id %>" style="animation-delay: <%= index * 0.05 %>s;">
                        <!-- Flag Badge -->
                        <div class="flag-badge">
                            <i class="fas fa-flag"></i>
                            <span><%= thread.moderationFlags.length %></span>
                        </div>

                        <!-- Card Header -->
                        <div class="flagged-card-header">
                            <div class="thread-info">
                                <div class="thread-title-row">
                                    <i class="fas fa-comments thread-icon"></i>
                                    <h3 class="thread-title">
                                        <a href="/forum/<%= thread.category.slug %>/<%= thread.slug %>" target="_blank">
                                            <%= thread.title %>
                                        </a>
                                    </h3>
                                </div>
                                <div class="thread-badges">
                                    <% if (thread.isPinned) { %>
                                        <span class="mini-badge badge-pinned">
                                            <i class="fas fa-thumbtack"></i> Fixada
                                        </span>
                                    <% } %>
                                    <% if (thread.isLocked) { %>
                                        <span class="mini-badge badge-locked">
                                            <i class="fas fa-lock"></i> Trancada
                                        </span>
                                    <% } %>
                                    <% if (!thread.isActive) { %>
                                        <span class="mini-badge badge-inactive">
                                            <i class="fas fa-eye-slash"></i> Inativa
                                        </span>
                                    <% } %>
                                </div>
                            </div>
                            
                            <div class="author-info">
                                <img src="<%= thread.author.avatar || '/images/default-avatar.png' %>" 
                                     alt="<%= thread.author.username %>" 
                                     class="author-avatar">
                                <div class="author-details">
                                    <span class="author-name">
                                        <%= thread.author.username %>
                                        <% if (thread.author.role === 'admin') { %>
                                            <i class="fas fa-crown admin-icon" title="Admin"></i>
                                        <% } else if (thread.author.role === 'moderator') { %>
                                            <i class="fas fa-shield-alt mod-icon" title="Moderador"></i>
                                        <% } %>
                                    </span>
                                    <span class="author-date">
                                        <%= new Date(thread.createdAt).toLocaleDateString('pt-BR', {
                                            day: '2-digit',
                                            month: 'short',
                                            year: 'numeric'
                                        }) %>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Content Preview -->
                        <div class="flagged-card-content">
                            <%= thread.content.substring(0, 250) %><%= thread.content.length > 250 ? '...' : '' %>
                        </div>

                        <!-- Reports Section -->
                        <div class="reports-section">
                            <div class="reports-header">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Motivos dos Reports:</span>
                            </div>
                            <div class="reports-list">
                                <% thread.moderationFlags.slice(0, 5).forEach(flag => { %>
                                    <div class="report-item">
                                        <div class="report-header">
                                            <i class="fas fa-user report-user-icon"></i>
                                            <span class="report-user"><%= flag.user ? flag.user.username : 'Usu√°rio desconhecido' %></span>
                                            <span class="report-date"><%= new Date(flag.createdAt).toLocaleDateString('pt-BR') %></span>
                                        </div>
                                        <div class="report-reason">
                                            <i class="fas fa-quote-left"></i>
                                            <span><%= flag.reason %></span>
                                        </div>
                                    </div>
                                <% }) %>
                                <% if (thread.moderationFlags.length > 5) { %>
                                    <div class="report-more">
                                        +<%= thread.moderationFlags.length - 5 %> mais...
                                    </div>
                                <% } %>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flagged-card-actions">
                            <a href="/forum/<%= thread.category.slug %>/<%= thread.slug %>" 
                               class="action-btn btn-primary" target="_blank">
                                <i class="fas fa-external-link-alt"></i>
                                <span>Ver Thread</span>
                            </a>
                            <button class="action-btn btn-warning" 
                                    onclick="lockThread('<%= thread._id %>', <%= !thread.isLocked %>)">
                                <i class="fas fa-<%= thread.isLocked ? 'unlock' : 'lock' %>"></i>
                                <span><%= thread.isLocked ? 'Destrancar' : 'Trancar' %></span>
                            </button>
                            <button class="action-btn btn-success" 
                                    onclick="dismissFlags('<%= thread._id %>', 'thread')">
                                <i class="fas fa-check"></i>
                                <span>Ignorar</span>
                            </button>
                            <button class="action-btn btn-danger" 
                                    onclick="deleteThread('<%= thread._id %>')">
                                <i class="fas fa-trash-alt"></i>
                                <span>Deletar</span>
                            </button>
                        </div>
                    </div>
                <% }) %>
            </div>
        <% } %>
    </div>

    <!-- Tab Content: Posts -->
    <div id="tab-posts" class="mod-tab-content">
        <% if (flaggedPosts.length === 0) { %>
            <div class="empty-state-modern">
                <div class="empty-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3>Nenhum post reportado</h3>
                <p>Tudo limpo por aqui! Continue o √≥timo trabalho. üéâ</p>
            </div>
        <% } else { %>
            <div class="flagged-list">
                <% flaggedPosts.forEach((post, index) => { %>
                    <div class="flagged-card" data-id="<%= post._id %>" style="animation-delay: <%= index * 0.05 %>s;">
                        <!-- Flag Badge -->
                        <div class="flag-badge">
                            <i class="fas fa-flag"></i>
                            <span><%= post.moderationFlags.length %></span>
                        </div>

                        <!-- Card Header -->
                        <div class="flagged-card-header">
                            <div class="thread-info">
                                <div class="thread-title-row">
                                    <i class="fas fa-comment thread-icon"></i>
                                    <h3 class="thread-title">
                                        Post em:
                                        <a href="/forum/<%= post.thread.slug %>" target="_blank">
                                            <%= post.thread.title %>
                                        </a>
                                    </h3>
                                </div>
                                <% if (!post.isActive) { %>
                                    <div class="thread-badges">
                                        <span class="mini-badge badge-inactive">
                                            <i class="fas fa-eye-slash"></i> Inativo
                                        </span>
                                    </div>
                                <% } %>
                            </div>
                            
                            <div class="author-info">
                                <img src="<%= post.author.avatar || '/images/default-avatar.png' %>" 
                                     alt="<%= post.author.username %>" 
                                     class="author-avatar">
                                <div class="author-details">
                                    <span class="author-name">
                                        <%= post.author.username %>
                                        <% if (post.author.role === 'admin') { %>
                                            <i class="fas fa-crown admin-icon" title="Admin"></i>
                                        <% } else if (post.author.role === 'moderator') { %>
                                            <i class="fas fa-shield-alt mod-icon" title="Moderador"></i>
                                        <% } %>
                                    </span>
                                    <span class="author-date">
                                        <%= new Date(post.createdAt).toLocaleDateString('pt-BR', {
                                            day: '2-digit',
                                            month: 'short',
                                            year: 'numeric'
                                        }) %>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Content Preview -->
                        <div class="flagged-card-content">
                            <%= post.content.substring(0, 250) %><%= post.content.length > 250 ? '...' : '' %>
                        </div>

                        <!-- Reports Section -->
                        <div class="reports-section">
                            <div class="reports-header">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Motivos dos Reports:</span>
                            </div>
                            <div class="reports-list">
                                <% post.moderationFlags.slice(0, 5).forEach(flag => { %>
                                    <div class="report-item">
                                        <div class="report-header">
                                            <i class="fas fa-user report-user-icon"></i>
                                            <span class="report-user"><%= flag.user ? flag.user.username : 'Usu√°rio desconhecido' %></span>
                                            <span class="report-date"><%= new Date(flag.createdAt).toLocaleDateString('pt-BR') %></span>
                                        </div>
                                        <div class="report-reason">
                                            <i class="fas fa-quote-left"></i>
                                            <span><%= flag.reason %></span>
                                        </div>
                                    </div>
                                <% }) %>
                                <% if (post.moderationFlags.length > 5) { %>
                                    <div class="report-more">
                                        +<%= post.moderationFlags.length - 5 %> mais...
                                    </div>
                                <% } %>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flagged-card-actions">
                            <button class="action-btn btn-success" 
                                    onclick="dismissFlags('<%= post._id %>', 'post')">
                                <i class="fas fa-check"></i>
                                <span>Ignorar</span>
                            </button>
                            <button class="action-btn btn-danger" 
                                    onclick="deletePost('<%= post._id %>')">
                                <i class="fas fa-trash-alt"></i>
                                <span>Deletar</span>
                            </button>
                        </div>
                    </div>
                <% }) %>
            </div>
        <% } %>
    </div>
</div>

<script>
function switchTab(tab) {
    // Remove active de todos
    document.querySelectorAll('.mod-tab').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.mod-tab-content').forEach(content => content.classList.remove('active'));
    
    // Ativa o selecionado
    document.querySelector(`.mod-tab[data-tab="${tab}"]`).classList.add('active');
    document.getElementById(`tab-${tab}`).classList.add('active');
}

async function lockThread(threadId, shouldLock) {
    if (!confirm(`Tem certeza que deseja ${shouldLock ? 'trancar' : 'destrancar'} esta thread?`)) return;
    
    try {
        const response = await fetch(`/forum/moderation/thread/${threadId}/lock`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lock: shouldLock })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Thread atualizada com sucesso!');
            location.reload();
        } else {
            alert(data.message || 'Erro ao atualizar thread');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao atualizar thread');
    }
}

async function deleteThread(threadId) {
    if (!confirm('Tem certeza que deseja DELETAR esta thread? Esta a√ß√£o n√£o pode ser desfeita.')) return;
    
    try {
        const response = await fetch(`/forum/moderation/thread/${threadId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Thread deletada com sucesso!');
            location.reload();
        } else {
            alert(data.message || 'Erro ao deletar thread');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao deletar thread');
    }
}

async function deletePost(postId) {
    if (!confirm('Tem certeza que deseja DELETAR este post? Esta a√ß√£o n√£o pode ser desfeita.')) return;
    
    try {
        const response = await fetch(`/forum/moderation/post/${postId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Post deletado com sucesso!');
            location.reload();
        } else {
            alert(data.message || 'Erro ao deletar post');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao deletar post');
    }
}

async function dismissFlags(itemId, type) {
    if (!confirm('Tem certeza que deseja ignorar todos os reports deste item?')) return;
    
    try {
        const response = await fetch(`/forum/moderation/${type}/${itemId}/dismiss-flags`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        if (data.success) {
            alert('Flags removidas com sucesso!');
            location.reload();
        } else {
            alert(data.message || 'Erro ao remover flags');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao remover flags');
    }
}
</script>

<%- include('../../partials/footer') %>
