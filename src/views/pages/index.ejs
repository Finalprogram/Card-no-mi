<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<style>
    .creators-home {
        margin-top: 20px;
        margin-bottom: 8px;
    }
    .creators-home h2 {
        margin-bottom: 8px;
    }
    .creators-home-subtitle {
        color: var(--text-secondary);
        margin-bottom: 18px;
    }
    .creators-home-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 16px;
    }
    .creator-home-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 14px;
    }
    .creator-home-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .creator-home-header h3 {
        margin: 0;
        font-size: 1.05rem;
    }
    .creator-home-header a {
        color: var(--accent-gold);
        text-decoration: none;
        font-size: 0.88rem;
    }
    .creator-home-videos {
        display: grid;
        grid-auto-flow: column;
        grid-auto-columns: minmax(250px, 1fr);
        gap: 10px;
        overflow-x: auto;
        padding-bottom: 4px;
        scrollbar-width: thin;
    }
    .creator-home-video {
        display: block;
        text-decoration: none;
        color: inherit;
        padding: 10px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid transparent;
        transition: all 160ms ease;
    }
    .creator-home-video:hover {
        border-color: rgba(var(--accent-primary-rgb), 0.45);
        background: rgba(var(--accent-primary-rgb), 0.10);
        transform: translateY(-1px);
    }
    .creator-home-video img {
        width: 100%;
        height: 140px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 8px;
    }
    .creator-home-video-info h4 {
        margin: 0 0 6px;
        font-size: 0.92rem;
        line-height: 1.35;
    }
    .creator-home-video-info span {
        color: var(--text-secondary);
        font-size: 0.8rem;
    }
    .creator-home-empty {
        color: var(--text-secondary);
        margin: 0;
    }
    .video-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.76);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2200;
        padding: 16px;
    }
    .video-modal-overlay.active {
        display: flex;
    }
    .video-modal-dialog {
        width: min(960px, 100%);
        background: #0f1115;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 14px;
        padding: 14px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.45);
    }
    .video-modal-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        gap: 10px;
    }
    .video-modal-title {
        margin: 0;
        font-size: 1rem;
        color: var(--text-primary);
    }
    .video-modal-close {
        border: 0;
        background: rgba(255, 255, 255, 0.08);
        color: #fff;
        border-radius: 8px;
        width: 34px;
        height: 34px;
        cursor: pointer;
    }
    .video-modal-frame-wrap {
        position: relative;
        width: 100%;
        padding-top: 56.25%;
        border-radius: 10px;
        overflow: hidden;
        background: #000;
    }
    .video-modal-frame-wrap iframe {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        border: 0;
    }

    @media (max-width: 600px) {
        .container {
            padding: 0 8px;
        }
        .hero {
            text-align: center;
            padding: 24px 0 12px 0;
        }
        .hero-logo-center img {
            max-width: 80vw;
            height: auto;
        }
        .hero-search {
            flex-direction: column;
            gap: 8px;
        }
        .hero-search input {
            width: 100%;
            font-size: 1.1em;
        }
        .hero-search button {
            width: 100%;
            font-size: 1em;
        }
        .recently-added {
            padding: 0;
        }
        .carousel-wrapper {
            flex-direction: column;
            align-items: center;
        }
        .cards-carousel {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        .card-item {
            min-width: 120px;
            max-width: 45vw;
        }
        .card-image-container img {
            max-width: 100%;
            height: auto;
        }
        .carousel-btn {
            font-size: 1.5em;
            padding: 8px;
        }
        .trust-features {
            padding: 0;
        }
        .creators-home-grid {
            grid-template-columns: 1fr;
        }
        .creator-home-video img {
            height: 120px;
        }
    }
</style>

<body class="public-site">
<!-- Card Detail Modal -->
<div class="card-modal-overlay" id="cardModal" onclick="closeCardModal(event)">
    <div class="card-modal-content" onclick="event.stopPropagation()">
        <button class="card-modal-close" onclick="closeCardModal()">&times;</button>
        
        <div class="card-modal-image-container">
            <img class="card-modal-image" id="modalCardImage" src="" alt="">
        </div>
        
        <div class="card-modal-info">
            <h3 id="modalCardName"></h3>
            
            <div class="card-modal-details">
                <div class="card-modal-detail-item" id="modalTypeContainer">
                    <div class="card-modal-detail-label">Tipo</div>
                    <div class="card-modal-detail-value" id="modalCardType"></div>
                </div>
                <div class="card-modal-detail-item" id="modalColorContainer">
                    <div class="card-modal-detail-label">Cor</div>
                    <div class="card-modal-detail-value" id="modalCardColor"></div>
                </div>
                <div class="card-modal-detail-item" id="modalCostContainer">
                    <div class="card-modal-detail-label">Custo</div>
                    <div class="card-modal-detail-value" id="modalCardCost"></div>
                </div>
                <div class="card-modal-detail-item" id="modalPowerContainer">
                    <div class="card-modal-detail-label">Poder</div>
                    <div class="card-modal-detail-value" id="modalCardPower"></div>
                </div>
            </div>
            
            <div class="card-modal-ability" id="modalAbilityContainer">
                <div class="card-modal-ability-label">Habilidade</div>
                <div class="card-modal-ability-text" id="modalCardAbility"></div>
            </div>
            
            <div class="card-modal-price" id="modalCardPrice"></div>
            
            <div class="card-modal-actions">
                <a id="modalCardLink" href="#" class="btn btn-primary" style="width: 100%;">Ver Página Completa</a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <main>
        <!-- 1. Seção "Herói" -->
        <section class="hero">
          
                        <h1>O seu Arsenal de Cartas em um Só Lugar</h1>
                        <div class="hero-logo-center">
                            <img src="/images/LogotipoCardnoMi.png" alt="Car'D No Mi Logo" class="hero-logo-inline">
                        </div>
            <p>Encontre, compre e venda cards de One Piece TCG! com segurança.</p>
            <form action="/cards" method="GET" class="hero-search">
  <input type="search" name="q" placeholder="Qual carta você procura?" required>
  <button>Buscar</button>
</form>
        </section>
        
        <section class="recently-added">
            <h2>Recém-Adicionados</h2>
            <div class="carousel-wrapper">
                <button class="carousel-btn prev" aria-label="Previous slide">‹</button>
                <div class="cards-carousel">
                    <% if (typeof recentListings !== 'undefined' && recentListings.length) { %>
                        <% recentListings.forEach(listing => { %>
                            <div class="card-item">
                                <div class="card-image-container" 
                                     data-card-id="<%= listing.card._id %>"
                                     data-card-name="<%= listing.card.name %>"
                                     data-card-image="<%= listing.card.image_url %>"
                                     data-card-price="<%= formatPrice(listing.price) %>"
                                     data-listing-id="<%= listing._id %>"
                                     data-card-type="<%= listing.card.type || '' %>"
                                     data-card-color="<%= listing.card.color || '' %>"
                                     data-card-cost="<%= listing.card.cost || '' %>"
                                     data-card-power="<%= listing.card.power || '' %>"
                                     data-card-ability="<%= (listing.card.ability || listing.card.effect || '').replace(/"/g, '&quot;') %>"
                                     onclick="openCardModal(this)">
                                    <img src="<%= listing.card.image_url %>" alt="<%= listing.card.name %>">
                                </div>
                                <div class="card-info">
                                    <h4><%= listing.card.name %></h4>
                                    <p><%= formatPrice(listing.price) %></p>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <p>Nenhuma carta encontrada.</p>
                    <% } %>
                </div>
                <button class="carousel-btn next" aria-label="Next slide">›</button>
            </div>
        </section>

        <!-- 4. Seção de Confiança -->
       <section class="creators-home">
            <h2>Nossos Criadores</h2>
           
            <% if (creatorsFeed && creatorsFeed.enabled && creatorsFeed.interleavedVideos && creatorsFeed.interleavedVideos.length > 0) { %>
                <div class="creator-home-videos">
                    <% creatorsFeed.interleavedVideos.forEach(video => { %>
                        <a class="creator-home-video" href="<%= video.videoUrl %>" data-video-id="<%= video.id %>" data-video-title="<%= video.title %>" rel="noopener noreferrer">
                            <img src="<%= video.thumbnail %>" alt="<%= video.title %>">
                            <div class="creator-home-video-info">
                                <h4><%= video.title %></h4>
                                <span><%= video.creatorDisplayName || video.creatorName %> • <%= new Date(video.publishedAt).toLocaleDateString('pt-BR') %></span>
                            </div>
                        </a>
                    <% }) %>
                </div>
            <% } else { %>
                <p class="creator-home-empty">Integração do YouTube em configuração. Em breve, os vídeos aparecerão aqui.</p>
            <% } %>
        </section>

<section class="trust-features">
  <h2>Negocie com Confiança</h2>
  <div class="features-grid">
    
    <div class="feature-item">
      <div class="feature-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
      </div>
      <div class="feature-text">
        <h3>Pagamento Protegido</h3>
        <p>Seu dinheiro fica seguro conosco até você receber o produto.</p>
      </div>
    </div>

    <div class="feature-item">
      <div class="feature-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>
      </div>
      <div class="feature-text">
        <h3>Vendedores Verificados</h3>
        <p>Compre de lojas com boa reputação e histórico na plataforma.</p>
      </div>
    </div>

    <div class="feature-item">
      <div class="feature-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
      </div>
      <div class="feature-text">
        <h3>Envio Garantido</h3>
        <p>Acompanhe seu pedido e tenha a garantia de recebimento.</p>
      </div>
    </div>

  </div>
</section>
        
    </main>
</div> <!-- A tag </div> do container é fechada aqui -->

<!-- Card Detail Modal -->
<div class="card-modal-overlay" id="cardModal" onclick="closeCardModal(event)">
    <div class="card-modal-content" onclick="event.stopPropagation()">
        <button class="card-modal-close" onclick="closeCardModal()">&times;</button>
        
        <div class="card-modal-image-container">
            <img class="card-modal-image" id="modalCardImage" src="" alt="">
        </div>
        
        <div class="card-modal-info">
            <h3 id="modalCardName"></h3>
            
            <div class="card-modal-details">
                <div class="card-modal-detail-item" id="modalTypeContainer">
                    <div class="card-modal-detail-label">Tipo</div>
                    <div class="card-modal-detail-value" id="modalCardType"></div>
                </div>
                <div class="card-modal-detail-item" id="modalColorContainer">
                    <div class="card-modal-detail-label">Cor</div>
                    <div class="card-modal-detail-value" id="modalCardColor"></div>
                </div>
                <div class="card-modal-detail-item" id="modalCostContainer">
                    <div class="card-modal-detail-label">Custo</div>
                    <div class="card-modal-detail-value" id="modalCardCost"></div>
                </div>
                <div class="card-modal-detail-item" id="modalPowerContainer">
                    <div class="card-modal-detail-label">Poder</div>
                    <div class="card-modal-detail-value" id="modalCardPower"></div>
                </div>
            </div>
            
            <div class="card-modal-ability" id="modalAbilityContainer">
                <div class="card-modal-ability-label">Habilidade</div>
                <div class="card-modal-ability-text" id="modalCardAbility"></div>
            </div>
            
            <div class="card-modal-price" id="modalCardPrice"></div>
            
            <div class="card-modal-actions">
                <a id="modalCardLink" href="#" class="btn btn-primary" style="width: 100%;">Ver Página Completa</a>
            </div>
        </div>
    </div>
</div>

<div class="video-modal-overlay" id="youtubeVideoModal">
    <div class="video-modal-dialog" onclick="event.stopPropagation()">
        <div class="video-modal-head">
            <h3 class="video-modal-title" id="youtubeVideoTitle">Vídeo</h3>
            <button type="button" class="video-modal-close" id="youtubeVideoClose" aria-label="Fechar vídeo">&times;</button>
        </div>
        <div class="video-modal-frame-wrap">
            <iframe id="youtubeVideoFrame" src="" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
        </div>
    </div>
</div>

<!-- Botão Flutuante do Carrinho -->
<a href="/carrinho" id="floating-cart-button" style="display: none;">
    <i class="fas fa-shopping-cart"></i>
    <span class="badge hidden">0</span>
</a>

<%- include('../partials/footer') %>

<script>
// Carousel controls
document.addEventListener('DOMContentLoaded', () => {
    const carousel = document.querySelector('.cards-carousel');
    const prevBtn = document.querySelector('.carousel-btn.prev');
    const nextBtn = document.querySelector('.carousel-btn.next');

    if (!carousel || !prevBtn || !nextBtn) {
        return;
    }

    const cardWidth = 220 + 24; // card width (220px) + gap (1.5rem = 24px)

    prevBtn.addEventListener('click', () => {
        carousel.scrollBy({ left: -cardWidth, behavior: 'smooth' });
    });

    nextBtn.addEventListener('click', () => {
        carousel.scrollBy({ left: cardWidth, behavior: 'smooth' });
    });

    const youtubeModal = document.getElementById('youtubeVideoModal');
    const youtubeFrame = document.getElementById('youtubeVideoFrame');
    const youtubeTitle = document.getElementById('youtubeVideoTitle');
    const youtubeClose = document.getElementById('youtubeVideoClose');

    const openYoutubeModal = (videoId, titleText) => {
        if (!youtubeModal || !youtubeFrame || !videoId) return;
        youtubeFrame.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
        if (youtubeTitle) youtubeTitle.textContent = titleText || 'Vídeo';
        youtubeModal.classList.add('active');
        document.body.style.overflow = 'hidden';
    };

    const closeYoutubeModal = () => {
        if (!youtubeModal || !youtubeFrame) return;
        youtubeModal.classList.remove('active');
        youtubeFrame.src = '';
        document.body.style.overflow = '';
    };

    document.querySelectorAll('.creator-home-video[data-video-id]').forEach(link => {
        link.addEventListener('click', (event) => {
            event.preventDefault();
            openYoutubeModal(link.dataset.videoId, link.dataset.videoTitle);
        });
    });

    if (youtubeModal) {
        youtubeModal.addEventListener('click', closeYoutubeModal);
    }
    if (youtubeClose) {
        youtubeClose.addEventListener('click', closeYoutubeModal);
    }

    window.closeYoutubeModal = closeYoutubeModal;
});

// Card Modal functions
window.openCardModal = function(element) {
    console.log('openCardModal chamado', element);
    const modal = document.getElementById('cardModal');
    console.log('Modal encontrado:', modal);
    
    if (!modal) {
        console.error('Modal #cardModal não encontrado no DOM!');
        return;
    }
    
    const cardId = element.dataset.cardId;
    const listingId = element.dataset.listingId;
    const cardName = element.dataset.cardName;
    const cardImage = element.dataset.cardImage;
    const cardPrice = element.dataset.cardPrice;
    const cardType = element.dataset.cardType;
    const cardColor = element.dataset.cardColor;
    const cardCost = element.dataset.cardCost;
    const cardPower = element.dataset.cardPower;
    const cardAbility = element.dataset.cardAbility;

    // Set image and name
    document.getElementById('modalCardImage').src = cardImage;
    document.getElementById('modalCardImage').alt = cardName;
    document.getElementById('modalCardName').textContent = cardName;
    
    // Set details (show/hide based on availability)
    const typeContainer = document.getElementById('modalTypeContainer');
    const colorContainer = document.getElementById('modalColorContainer');
    const costContainer = document.getElementById('modalCostContainer');
    const powerContainer = document.getElementById('modalPowerContainer');
    const abilityContainer = document.getElementById('modalAbilityContainer');
    
    if (cardType) {
        document.getElementById('modalCardType').textContent = cardType;
        typeContainer.style.display = 'block';
    } else {
        typeContainer.style.display = 'none';
    }
    
    if (cardColor) {
        document.getElementById('modalCardColor').textContent = cardColor;
        colorContainer.style.display = 'block';
    } else {
        colorContainer.style.display = 'none';
    }
    
    if (cardCost) {
        document.getElementById('modalCardCost').textContent = cardCost;
        costContainer.style.display = 'block';
    } else {
        costContainer.style.display = 'none';
    }
    
    if (cardPower) {
        document.getElementById('modalCardPower').textContent = cardPower;
        powerContainer.style.display = 'block';
    } else {
        powerContainer.style.display = 'none';
    }
    
    if (cardAbility) {
        document.getElementById('modalCardAbility').textContent = cardAbility;
        abilityContainer.style.display = 'block';
    } else {
        abilityContainer.style.display = 'none';
    }
    
    // Set price and link
    document.getElementById('modalCardPrice').textContent = cardPrice;
    document.getElementById('modalCardLink').href = `/card/${cardId}`;

    console.log('Abrindo modal...');
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    console.log('Modal aberto! Classes:', modal.classList);
}

function closeCardModal(event) {
    if (!event || event.target === document.getElementById('cardModal')) {
        const modal = document.getElementById('cardModal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }
}

// Close modal with ESC key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeCardModal();
        if (typeof window.closeYoutubeModal === 'function') {
            window.closeYoutubeModal();
        }
    }
});

// Update cart badge on page load
async function updateCartBadge() {
    try {
        const floatingBtn = document.getElementById('floating-cart-button');
        if (!floatingBtn) return;

        const response = await fetch('/cart/json');
        if (!response.ok) return;
        
        const data = await response.json();
        const count = Number(data.totalQty || 0);
        
        const badge = floatingBtn.querySelector('.badge');
        if (badge) {
            badge.textContent = String(count);
            badge.classList.toggle('hidden', count <= 0);
        }

        // Show floating button if there are items
        if (count > 0) {
            floatingBtn.style.display = 'flex';
        }
    } catch (error) {
        console.error('Erro ao atualizar badge do carrinho:', error);
    }
}

// Update badge on page load
updateCartBadge();
</script>

