<%- include('../partials/header') %>
<style>
    .hero-search input {
        position: relative;
        overflow: hidden;
    }

    .hero-search input:focus {
        outline: none;
        border-color: transparent; /* Remove default border */
    }

    .hero-search input:focus::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(to right, var(--accent-primary), var(--accent-hover));
        animation: expand-border 0.5s forwards;
    }

    @keyframes expand-border {
        from { width: 0; }
        to { width: 100%; }
    }
</style>

<body class="public-site">

<div class="container">
    <%- include('../partials/navbar') %>

    <main>
        <!-- 1. Seção "Herói" -->
        <section class="hero">
          <form action="/cards" method="GET" class="hero-search">
  <input type="search" name="q" placeholder="Qual carta você procura?" required>
  <button>Buscar</button>
</form>
            <h1>O seu Arsenal de Cartas em um Só Lugar <img src="/images/fruta.png" alt="Car'D No Mi Logo" class="hero-logo-inline"></h1>
            <p>Encontre, compre e venda cards de One Piece TCG! com segurança.</p>
            
        </section>
        <section class="recently-added">
            <h2>Recém-Adicionados</h2>
            <div class="carousel-wrapper">
                <button class="carousel-btn prev" aria-label="Previous slide">‹</button>
                <div class="cards-carousel">
                    <% if (typeof recentListings !== 'undefined' && recentListings.length) { %>
                        <% recentListings.forEach(listing => { %>
                            <div class="card-item">
                                <div class="card-image-container" 
                                     data-card-id="<%= listing.card._id %>"
                                     data-card-name="<%= listing.card.name %>"
                                     data-card-image="<%= listing.card.image_url %>"
                                     data-card-price="<%= formatPrice(listing.price) %>"
                                     data-listing-id="<%= listing._id %>"
                                     data-card-type="<%= listing.card.type || '' %>"
                                     data-card-color="<%= listing.card.color || '' %>"
                                     data-card-cost="<%= listing.card.cost || '' %>"
                                     data-card-power="<%= listing.card.power || '' %>"
                                     data-card-ability="<%= (listing.card.ability || listing.card.effect || '').replace(/"/g, '&quot;') %>"
                                     onclick="openCardModal(this)">
                                    <img src="<%= listing.card.image_url %>" alt="<%= listing.card.name %>">
                                </div>
                                <div class="card-info">
                                    <h4><%= listing.card.name %></h4>
                                    <p><%= formatPrice(listing.price) %></p>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <p>Nenhuma carta encontrada.</p>
                    <% } %>
                </div>
                <button class="carousel-btn next" aria-label="Next slide">›</button>
            </div>
        </section>

        <!-- 4. Seção de Confiança -->
       <section class="trust-features">
  <h2>Negocie com Confiança</h2>
  <div class="features-grid">
    
    <div class="feature-item">
      <div class="feature-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
      </div>
      <div class="feature-text">
        <h3>Pagamento Protegido</h3>
        <p>Seu dinheiro fica seguro conosco até você receber o produto.</p>
      </div>
    </div>

    <div class="feature-item">
      <div class="feature-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>
      </div>
      <div class="feature-text">
        <h3>Vendedores Verificados</h3>
        <p>Compre de lojas com boa reputação e histórico na plataforma.</p>
      </div>
    </div>

    <div class="feature-item">
      <div class="feature-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
      </div>
      <div class="feature-text">
        <h3>Envio Garantido</h3>
        <p>Acompanhe seu pedido e tenha a garantia de recebimento.</p>
      </div>
    </div>

  </div>
</section>
    </main>
</div> <!-- A tag </div> do container é fechada aqui -->

<!-- Card Detail Modal -->
<div class="card-modal-overlay" id="cardModal" onclick="closeCardModal(event)">
    <div class="card-modal-content" onclick="event.stopPropagation()">
        <button class="card-modal-close" onclick="closeCardModal()">&times;</button>
        
        <div class="card-modal-image-container">
            <img class="card-modal-image" id="modalCardImage" src="" alt="">
        </div>
        
        <div class="card-modal-info">
            <h3 id="modalCardName"></h3>
            
            <div class="card-modal-details">
                <div class="card-modal-detail-item" id="modalTypeContainer">
                    <div class="card-modal-detail-label">Tipo</div>
                    <div class="card-modal-detail-value" id="modalCardType"></div>
                </div>
                <div class="card-modal-detail-item" id="modalColorContainer">
                    <div class="card-modal-detail-label">Cor</div>
                    <div class="card-modal-detail-value" id="modalCardColor"></div>
                </div>
                <div class="card-modal-detail-item" id="modalCostContainer">
                    <div class="card-modal-detail-label">Custo</div>
                    <div class="card-modal-detail-value" id="modalCardCost"></div>
                </div>
                <div class="card-modal-detail-item" id="modalPowerContainer">
                    <div class="card-modal-detail-label">Poder</div>
                    <div class="card-modal-detail-value" id="modalCardPower"></div>
                </div>
            </div>
            
            <div class="card-modal-ability" id="modalAbilityContainer">
                <div class="card-modal-ability-label">Habilidade</div>
                <div class="card-modal-ability-text" id="modalCardAbility"></div>
            </div>
            
            <div class="card-modal-price" id="modalCardPrice"></div>
            
            <div class="card-modal-actions">
                <a id="modalCardLink" href="#" class="btn btn-primary" style="width: 100%;">Ver Página Completa</a>
            </div>
        </div>
    </div>
</div>

<!-- Botão Flutuante do Carrinho -->
<a href="/carrinho" id="floating-cart-button" style="display: none;">
    <i class="fas fa-shopping-cart"></i>
    <span class="badge hidden">0</span>
</a>

<%- include('../partials/footer') %>

<script>
// Carousel controls
document.addEventListener('DOMContentLoaded', () => {
    const carousel = document.querySelector('.cards-carousel');
    const prevBtn = document.querySelector('.carousel-btn.prev');
    const nextBtn = document.querySelector('.carousel-btn.next');

    if (!carousel || !prevBtn || !nextBtn) {
        return;
    }

    const cardWidth = 220 + 24; // card width (220px) + gap (1.5rem = 24px)

    prevBtn.addEventListener('click', () => {
        carousel.scrollBy({ left: -cardWidth, behavior: 'smooth' });
    });

    nextBtn.addEventListener('click', () => {
        carousel.scrollBy({ left: cardWidth, behavior: 'smooth' });
    });
});

// Card Modal functions
function openCardModal(element) {
    const modal = document.getElementById('cardModal');
    const cardId = element.dataset.cardId;
    const listingId = element.dataset.listingId;
    const cardName = element.dataset.cardName;
    const cardImage = element.dataset.cardImage;
    const cardPrice = element.dataset.cardPrice;
    const cardType = element.dataset.cardType;
    const cardColor = element.dataset.cardColor;
    const cardCost = element.dataset.cardCost;
    const cardPower = element.dataset.cardPower;
    const cardAbility = element.dataset.cardAbility;

    // Set image and name
    document.getElementById('modalCardImage').src = cardImage;
    document.getElementById('modalCardImage').alt = cardName;
    document.getElementById('modalCardName').textContent = cardName;
    
    // Set details (show/hide based on availability)
    const typeContainer = document.getElementById('modalTypeContainer');
    const colorContainer = document.getElementById('modalColorContainer');
    const costContainer = document.getElementById('modalCostContainer');
    const powerContainer = document.getElementById('modalPowerContainer');
    const abilityContainer = document.getElementById('modalAbilityContainer');
    
    if (cardType) {
        document.getElementById('modalCardType').textContent = cardType;
        typeContainer.style.display = 'block';
    } else {
        typeContainer.style.display = 'none';
    }
    
    if (cardColor) {
        document.getElementById('modalCardColor').textContent = cardColor;
        colorContainer.style.display = 'block';
    } else {
        colorContainer.style.display = 'none';
    }
    
    if (cardCost) {
        document.getElementById('modalCardCost').textContent = cardCost;
        costContainer.style.display = 'block';
    } else {
        costContainer.style.display = 'none';
    }
    
    if (cardPower) {
        document.getElementById('modalCardPower').textContent = cardPower;
        powerContainer.style.display = 'block';
    } else {
        powerContainer.style.display = 'none';
    }
    
    if (cardAbility) {
        document.getElementById('modalCardAbility').textContent = cardAbility;
        abilityContainer.style.display = 'block';
    } else {
        abilityContainer.style.display = 'none';
    }
    
    // Set price and link
    document.getElementById('modalCardPrice').textContent = cardPrice;
    document.getElementById('modalCardLink').href = `/card/${cardId}`;

    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeCardModal(event) {
    if (!event || event.target === document.getElementById('cardModal')) {
        const modal = document.getElementById('cardModal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }
}

// Close modal with ESC key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeCardModal();
    }
});

// Update cart badge on page load
async function updateCartBadge() {
    try {
        const floatingBtn = document.getElementById('floating-cart-button');
        if (!floatingBtn) return;

        const response = await fetch('/cart/json');
        if (!response.ok) return;
        
        const data = await response.json();
        const count = Number(data.totalQty || 0);
        
        const badge = floatingBtn.querySelector('.badge');
        if (badge) {
            badge.textContent = String(count);
            badge.classList.toggle('hidden', count <= 0);
        }

        // Show floating button if there are items
        if (count > 0) {
            floatingBtn.style.display = 'flex';
        }
    } catch (error) {
        console.error('Erro ao atualizar badge do carrinho:', error);
    }
}

// Update badge on page load
updateCartBadge();
</script>

