<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/cartController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/cartController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const User = require('../models/User');
const Listing = require('../models/Listing');

/** Cria/retorna o carrinho na sessão */
function getCart(req) {
  if (!req.session.cart) {
    req.session.cart = { items: [], totalQty: 0, totalPrice: 0 };
  }
  return req.session.cart;
}

/** Recalcula totais do carrinho */
function recompute(cart) {
  let totalQty = 0;
  let totalPrice = 0;
  for (const it of cart.items) {
    totalQty += it.qty;
    totalPrice += it.qty * it.price;
  }
  cart.totalQty = totalQty;
  cart.totalPrice = Number(totalPrice.toFixed(2));
}

/** Normaliza meta para garantir campos úteis no front/checkout */
function normalizeMeta(baseMeta = {}, { cardId, vendorId }) {
  const safe = { ...baseMeta };

  // IDs chave para split por vendedor no checkout
  safe.sellerId   = safe.sellerId   || vendorId;
  safe.sellerName = safe.sellerName || baseMeta?.sellerName || 'Vendedor';

  // Dados da carta para exibir no modal
  safe.cardId    = safe.cardId    || cardId;
  safe.cardName  = safe.cardName  || baseMeta?.cardName  || 'Carta';
  safe.imageUrl  = safe.imageUrl  || baseMeta?.imageUrl  || '/img/card-placeholder.png';
  safe.condition = safe.condition || baseMeta?.condition || null;

  // Origem do frete (se você já tiver isso por vendedor)
  // Pode vir preenchido do front ou popular aqui via DB num próximo passo
  safe.originZip = (safe.originZip || '').replace?.(/\D/g, '') || null;

  return safe;
}

/** POST /cart/add  (JSON: { cardId, vendorId, price, qty, meta? }) */
async function add(req, res) {
  try {
    const { cardId, vendorId, price, qty, meta, listingId } = req.body || {};
    const q = Number(qty);
    const p = Number(price);

    if (!cardId || !vendorId || !Number.isFinite(p) || !Number.isFinite(q) || q &lt; 1 || !listingId) {
      return res.status(400).json({ error: 'Dados inválidos ou listingId ausente.' });
    }

    // --- VALIDAÇÃO DE ESTOQUE ---
    const listing = await Listing.findById(listingId);
    if (!listing) {
      return res.status(404).json({ error: 'Anúncio não encontrado ou removido.' });
    }
    if (listing.stock &lt; 1) {
      return res.status(400).json({ error: 'Produto sem estoque disponível.' });
    }

    const cart = getCart(req);
    const key = `${cardId}:${vendorId}:${listingId}`; // Incluir listingId na chave para unicidade

    let found = cart.items.find(i => i.key === key);
    let currentQtyInCart = found ? found.qty : 0;
    let requestedTotalQty = currentQtyInCart + q;

    if (requestedTotalQty > listing.stock) {
      return res.status(400).json({ error: `Quantidade solicitada excede o estoque disponível (${listing.stock}).` });
    }
    // --- FIM DA VALIDAÇÃO DE ESTOQUE ---

    // --- NOVA VALIDAÇÃO ---
    // Verifica se o vendedor realmente existe antes de adicionar ao carrinho
    const seller = await User.findById(vendorId);
    if (!seller) {
      return res.status(404).json({ error: 'Vendedor não encontrado. O anúncio pode ter sido removido.' });
    }
    if (!req.session.user || !req.session.user.id) {
      return res.status(401).json({ error: 'Usuário não autenticado.' });
    }
    // TODO: Re-enable this check after fixing the session issue
    // if (seller._id.toString() === req.session.user.id.toString()) {
    //   return res.status(403).json({ error: 'Você não pode comprar seus próprios itens.' });
    // }
    // --- FIM DA VALIDAÇÃO ---

    if (!found) {
      found = {
        key,
        cardId,
        vendorId,
        listingId, // Adicionado para referência futura
        price: p,
        qty: 0,
        meta: normalizeMeta(meta, { cardId, vendorId })
      };
      cart.items.push(found);
    } else {
      if (Number.isFinite(p)) found.price = p;
      found.meta = normalizeMeta({ ...(found.meta || {}), ...(meta || {}) }, { cardId, vendorId });
    }

    found.qty = requestedTotalQty; // Atualiza com a quantidade total solicitada
    recompute(cart);

    return res.json({ ok: true, count: cart.totalQty, total: cart.totalPrice });
  } catch (err) {
    console.error('cartController.add error:', err);
    return res.status(500).json({ error: 'Erro interno' });
  }
}

/** POST /cart/update  (JSON: { key, qty }) */
async function update(req, res) {
  try {
    const { key, qty } = req.body || {};
    const q = Number(qty);
    if (!key || !Number.isFinite(q) || q &lt; 1) {
      return res.status(400).json({ error: 'Dados inválidos' });
    }
    const cart = getCart(req);
    const it = cart.items.find(i => i.key === key);
    if (!it) return res.status(404).json({ error: 'Item não encontrado' });

    it.qty = Math.min(999, q);
    recompute(cart);
    return res.json({ ok: true, count: cart.totalQty, total: cart.totalPrice });
  } catch (err) {
    console.error('cartController.update error:', err);
    return res.status(500).json({ error: 'Erro interno' });
  }
}

/** POST /cart/remove  (JSON: { key }) */
async function remove(req, res) {
  try {
    const { key } = req.body || {};
    const cart = getCart(req);
    const before = cart.items.length;
    cart.items = cart.items.filter(i => i.key !== key);
    if (cart.items.length !== before) recompute(cart);
    return res.json({ ok: true, count: cart.totalQty, total: cart.totalPrice });
  } catch (err) {
    console.error('cartController.remove error:', err);
    return res.status(500).json({ error: 'Erro interno' });
  }
}

/** POST /cart/clear */
async function clear(req, res) {
  try {
    req.session.cart = { items: [], totalQty: 0, totalPrice: 0 };
    return res.json({ ok: true, count: 0, total: 0 });
  } catch (err) {
    console.error('cartController.clear error:', err);
    return res.status(500).json({ error: 'Erro interno' });
  }
}

/**
 * GET /cart → renderiza a página se existir; se não, devolve JSON
 * Dica: se você não tem views/cart.ejs, prefira usar apenas /cart/json no modal
 */
async function show(req, res) {
  try {
    const cart = getCart(req);
    return res.render('pages/cart', { cart });
  } catch (err) {
    // fallback em JSON caso a view não exista para não quebrar
    return res.json(getCart(req));
  }
}

/** GET /cart/json → resposta limpa pro modal do front */
async function json(req, res) {
  try {
    const cart = getCart(req);

    // Garante que todos os itens têm meta normalizada (evita undefined no front)
    cart.items = cart.items.map(it => ({
      ...it,
      meta: normalizeMeta(it.meta, { cardId: it.cardId, vendorId: it.vendorId })
    }));

    // recompute por segurança (se algo mudou)
    recompute(cart);

    return res.json(cart);
  } catch (err) {
    console.error('cartController.json error:', err);
    return res.status(500).json({ error: 'Erro interno' });
  }
}

module.exports = {
  add,
  update,
  remove,
  clear,
  show,
  json,
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#add">add</a></li><li><a href="global.html#addItemToCart">addItemToCart</a></li><li><a href="global.html#addPostPaymentJob">addPostPaymentJob</a></li><li><a href="global.html#clear">clear</a></li><li><a href="global.html#confirm">confirm</a></li><li><a href="global.html#cotarFreteMelhorEnvio">cotarFreteMelhorEnvio</a></li><li><a href="global.html#ensureAddress">ensureAddress</a></li><li><a href="global.html#generateLabels">generateLabels</a></li><li><a href="global.html#getCart">getCart</a></li><li><a href="global.html#json">json</a></li><li><a href="global.html#normalizeMeta">normalizeMeta</a></li><li><a href="global.html#printLabels">printLabels</a></li><li><a href="global.html#purchaseShipments">purchaseShipments</a></li><li><a href="global.html#quoteDetailed">quoteDetailed</a></li><li><a href="global.html#recompute">recompute</a></li><li><a href="global.html#remove">remove</a></li><li><a href="global.html#show">show</a></li><li><a href="global.html#showCheckout">showCheckout</a></li><li><a href="global.html#showPayment">showPayment</a></li><li><a href="global.html#update">update</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Fri Nov 07 2025 23:39:33 GMT-0300 (Horário Padrão de Brasília)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
